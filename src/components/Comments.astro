---
import '../styles/global.css';
import { getUserFromCookie } from '../lib/auth';
import User from '../models/User';
import mongoose from 'mongoose';

interface Props {
  slug: string;
}

const { slug } = Astro.props;

interface CurrentUser {
  id: string;
  name: string;
  email: string;
  picture?: string;
}

// Get current user
const cookieHeader = Astro.request.headers.get('cookie');
const userPayload = getUserFromCookie(cookieHeader);
let currentUser: CurrentUser | null = null;

if (userPayload) {
  try {
     if (mongoose.connection.readyState !== 1) {
        const MONGODB_URI = import.meta.env.MONGODB_URI;
        if (MONGODB_URI) await mongoose.connect(MONGODB_URI);
     }
     const userDoc = await User.findById(userPayload.userId);
     if (userDoc) {
       currentUser = {
         id: userDoc._id.toString(),
         name: userDoc.name,
         email: userDoc.email,
         picture: userDoc.picture
       };
     }
  } catch (e) {
    console.error('Error fetching user for comments:', e);
  }
}
const isLoggedIn = !!currentUser;
---

<section id="comments-section" class="comments-container">
  <!-- Section Header -->
  <div class="comments-header fade-in-up">
    <div class="header-title">
      <h3 class="gradient-text">Comentarios</h3>
      <span class="comment-count-pill" id="comment-count-label">0</span>
    </div>

    <!-- Sorting Control -->
    <div class="sort-control">
      <label for="sort-select" class="sr-only">Ordenar por</label>
      <select id="sort-select" class="sort-select">
        <option value="newest">M√°s recientes</option>
        <option value="oldest">M√°s antiguos</option>
        <option value="top">Mejor valorados</option>
      </select>
      <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="comments-grid">
    
    <!-- Comment Form Card -->
    <div class="comment-form-wrapper fade-in-up delay-100">
      <div class="glass-card form-card">
        <div class="card-header">
          <div class="avatar-spot">
            {isLoggedIn && currentUser?.picture ? (
              <img src={currentUser.picture} alt={currentUser.name} class="user-avatar" />
            ) : (
              <div class="user-avatar-placeholder">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              </div>
            )}
          </div>
          <div class="header-text">
            <h4>{isLoggedIn && currentUser ? `Hola, ${currentUser.name}` : '√önete a la conversaci√≥n'}</h4>
            <p>{isLoggedIn ? 'Comparte tu opini√≥n sobre este episodio' : 'Inicia sesi√≥n o comenta como invitado'}</p>
          </div>
        </div>

        <form id="comment-form" class="comment-form">
          {isLoggedIn && currentUser ? (
            <input type="hidden" name="name" value={currentUser.name} />
            <input type="hidden" name="email" value={currentUser.email} />
          ) : (
            <div class="guest-inputs">
              <div class="input-group">
                <input type="text" id="name" name="name" placeholder=" " required maxlength="60" />
                <label for="name">Nombre</label>
              </div>
              <div class="input-group">
                <input type="email" id="email" name="email" placeholder=" " required />
                <label for="email">Email <span class="dim">(no visible)</span></label>
              </div>
            </div>
          )}

          <div class="input-group full-width">
            <textarea id="text" name="text" rows="3" placeholder=" " required maxlength="1000"></textarea>
            <label for="text">Escribe tu comentario...</label>
            <div class="focus-border"></div>
          </div>

          <!-- Bottom Actions: Rating & Submit -->
          <div class="form-actions">
            <div class="rating-picker">
              <span class="rating-label">Tu valoraci√≥n:</span>
              <div class="stars-interactive" id="star-interactive">
                {[1, 2, 3, 4, 5].map((val) => (
                  <button type="button" class="star-btn" data-value={val} aria-label={`${val} estrellas`}>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                  </button>
                ))}
              </div>
              <input type="hidden" name="rating" id="rating-value" value="0" />
            </div>

            <button type="submit" class="submit-btn">
              <span>Publicar</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
          </div>
          <p id="form-status" class="status-msg"></p>
        </form>
      </div>
    </div>

    <!-- Comments Feed -->
    <div class="comments-feed-wrapper fade-in-up delay-200">
      <div id="comments-list" class="comments-list">
        <!-- Loading Skeleton -->
        <div class="skeleton-loader">
          <div class="skeleton-item"></div>
          <div class="skeleton-item"></div>
          <div class="skeleton-item"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container"></div>
</section>

<script define:vars={{ slug }}>
  // UI Elements
  const form = document.getElementById('comment-form');
  const list = document.getElementById('comments-list');
  const countLabel = document.getElementById('comment-count-label');
  const sortSelect = document.getElementById('sort-select');
  const toastContainer = document.getElementById('toast-container');
  
  // State
  let allComments = [];
  let currentSort = 'newest';

  // --- INITIALIZATION ---
  document.addEventListener('DOMContentLoaded', () => {
    fetchComments();
    
    if (sortSelect) {
      sortSelect.addEventListener('change', (e) => {
        currentSort = e.target.value;
        renderComments(); // Re-render with new sort
      });
    }
  });

  // --- API OPERATIONS ---
  async function fetchComments() {
    try {
      if(list) list.innerHTML = getSkeletonHTML();
      
      const res = await fetch(`/api/comments/${slug}`);
      const json = await res.json();
      
      if (json.success) {
        allComments = json.data;
        renderComments();
      } else {
        showToast('No se pudieron cargar los comentarios', 'error');
        list.innerHTML = getEmptyStateHTML('Error de conexi√≥n');
      }
    } catch (e) {
      console.error(e);
      list.innerHTML = getEmptyStateHTML();
    }
  }

  // --- RENDERING ---
  function renderComments() {
    if (!allComments || allComments.length === 0) {
      list.innerHTML = getEmptyStateHTML();
      countLabel.innerText = '0';
      return;
    }

    // Sort Logic
    let sorted = [...allComments];
    if (currentSort === 'newest') {
      sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    } else if (currentSort === 'oldest') {
      sorted.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
    } else if (currentSort === 'top') {
      sorted.sort((a, b) => b.rating - a.rating); // Sort by rating descending
    }

    countLabel.innerText = sorted.length;

    // Render List
    list.innerHTML = sorted.map(c => `
      <article class="comment-card fade-in-up" id="comment-${c._id}">
        <div class="card-side">
          <div class="avatar-circle" style="background-color: ${stringToColor(c.name)}">
             ${c.avatar && !c.avatar.includes('placeholder') ? `<img src="${c.avatar}" alt="${escapeHtml(c.name)}" />` : c.name.charAt(0).toUpperCase()}
          </div>
        </div>
        <div class="card-main">
          <header class="comment-header">
             <div class="author-meta">
               <span class="author-name">${escapeHtml(c.name)}</span>
               ${c.rating > 0 ? renderStars(c.rating) : ''}
             </div>
             <div class="meta-right">
                <button 
                  class="like-btn ${c.isLiked ? 'liked' : ''}" 
                  title="${c.isLiked ? 'Quitar like' : 'Me gusta'}" 
                  onclick="requestLike('${c._id}')"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="${c.isLiked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                  ${c.likesCount > 0 ? `<span class="like-count">${c.likesCount}</span>` : ''}
                </button>
                <time title="${new Date(c.createdAt).toLocaleString()}">${timeAgo(new Date(c.createdAt))}</time>
                <button class="delete-btn" title="Eliminar" onclick="requestDelete('${c._id}')">
                   <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
             </div>
          </header>
          <div class="comment-body">
            ${escapeHtml(c.text)}
          </div>
        </div>
      </article>
    `).join('');
  }

  // --- HELPERS ---
  function getSkeletonHTML() {
    return `
      <div class="skeleton-wrapper">
         ${[1,2,3].map(() => `
           <div class="skeleton-card">
              <div class="sk-avatar"></div>
              <div class="sk-content">
                <div class="sk-line w-30"></div>
                <div class="sk-line w-80"></div>
                <div class="sk-line w-60"></div>
              </div>
           </div>
         `).join('')}
      </div>
    `;
  }

  function getEmptyStateHTML(msg = 'S√© la primera persona en opinar.') {
    return `
      <div class="empty-state">
        <div class="empty-icon shadow-glow">üí¨</div>
        <h3>Sin comentarios a√∫n</h3>
        <p>${msg}</p>
      </div>
    `;
  }

  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));
  }

  function timeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    const rtf = new Intl.RelativeTimeFormat('es', { numeric: 'auto' });
    if (seconds < 60) return 'ahora';
    if (seconds < 3600) return rtf.format(-Math.floor(seconds / 60), 'minute');
    if (seconds < 86400) return rtf.format(-Math.floor(seconds / 3600), 'hour');
    if (seconds < 604800) return rtf.format(-Math.floor(seconds / 86400), 'day');
    return rtf.format(-Math.floor(seconds / 2592000), 'month');
  }

  function renderStars(rating) {
    return `<div class="mini-stars" title="${rating}/5">
       ${Array(5).fill(0).map((_, i) => `
         <svg class="${i < rating ? 'filled' : ''}" viewBox="0 0 24 24" fill="currentColor">
           <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
         </svg>
       `).join('')}
    </div>`;
  }

  function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    const hue = Math.abs(hash % 360);
    return `hsl(${hue}, 60%, 50%)`;
  }

  // --- ACTIONS ---
  
  // Like
  window.requestLike = async (commentId) => {
      // Optimistic Update
      const commentIndex = allComments.findIndex(c => c._id === commentId);
      if (commentIndex === -1) return;

      const previousState = { ...allComments[commentIndex] };
      const comment = allComments[commentIndex];
      
      // Toggle locally first
      if (comment.isLiked) {
          comment.isLiked = false;
          comment.likesCount--;
      } else {
          comment.isLiked = true;
          comment.likesCount++;
      }
      
      // Re-render only that card? Or simpler to just re-render list since it's fast enough 
      // renderComments() replaces innerHTML which breaks animations/focus. 
      // Ideally we should update just the DOM element, but for now re-render is okayish or better, query selector.
      
      const btn = document.querySelector(`#comment-${commentId} .like-btn`);
      if(btn) {
         if(comment.isLiked) {
            btn.classList.add('liked');
            btn.querySelector('svg').setAttribute('fill', 'currentColor');
         } else {
            btn.classList.remove('liked');
            btn.querySelector('svg').setAttribute('fill', 'none');
         }
         const countSpan = btn.querySelector('.like-count');
         if(countSpan) {
            countSpan.innerText = comment.likesCount > 0 ? comment.likesCount : '';
            if(comment.likesCount === 0) countSpan.remove();
         } else if (comment.likesCount > 0) {
            // Append if it didn't exist
            const span = document.createElement('span');
            span.className = 'like-count';
            span.innerText = comment.likesCount;
            btn.appendChild(span);
         }
      }

      try {
          const res = await fetch('/api/comments/like', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ commentId })
          });
          const json = await res.json();
          
          if (!json.success) {
               if(res.status === 401) {
                  showToast('Inicia sesi√≥n para dar like', 'info');
               } else {
                  showToast(json.error || 'Error', 'error');
               }
               // Revert
               allComments[commentIndex] = previousState;
               renderComments();
          } else {
              // Sync with server source of truth
              allComments[commentIndex].likesCount = json.likesCount;
              allComments[commentIndex].isLiked = json.liked;
              // Update specific element again just to be sure
              // renderComments(); 
          }
      } catch (e) {
          showToast('Error de conexi√≥n', 'error');
          allComments[commentIndex] = previousState;
          renderComments();
      }
  };

  // Delete
  window.requestDelete = async (commentId) => {
      if(!confirm('¬øSolicitar borrado de este comentario? (Se enviar√° un email)')) return;
      
      try {
          const res = await fetch(`/api/comments/${slug}`, {
              method: 'DELETE',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ commentId })
          });
          const json = await res.json();
          showToast(json.success ? 'Email de confirmaci√≥n enviado' : (json.error || 'Error'), json.success ? 'success' : 'error');
      } catch (e) {
          showToast('Error de conexi√≥n', 'error');
      }
  };

  // Submit
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = form.querySelector('.submit-btn');
      const originalContent = btn.innerHTML;
      
      // Validation
      const formData = new FormData(form);
      const data = {
        name: formData.get('name'),
        email: formData.get('email'),
        text: formData.get('text'),
        rating: parseInt(formData.get('rating') || '0', 10)
      };

      try {
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner"></span> Enviando...`;
        
        const res = await fetch(`/api/comments/${slug}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const json = await res.json();

        if (json.success) {
           form.reset();
           // Reset stars
           document.querySelectorAll('.star-btn').forEach(s => s.classList.remove('active'));
           document.getElementById('rating-value').value = '0';
           
           if (json.pending === false) {
             showToast('Comentario publicado', 'success');
             fetchComments(); // Reload
           } else {
             showToast('Verifica tu email para publicar', 'info');
           }
        } else {
           showToast(json.error || 'Error al publicar', 'error');
        }
      } catch (e) {
         showToast('Error de conexi√≥n', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalContent;
      }
    });

    // Interactive Stars Logic
    const starsContainer = document.getElementById('star-interactive');
    const ratingInput = document.getElementById('rating-value');
    if (starsContainer) {
       const starBtns = starsContainer.querySelectorAll('.star-btn');
       starBtns.forEach(btn => {
          btn.addEventListener('click', () => {
             const val = btn.dataset.value;
             ratingInput.value = val;
             updateInteractiveStars(val);
          });
          btn.addEventListener('mouseenter', () => updateInteractiveStars(btn.dataset.value, true));
       });
       
       starsContainer.addEventListener('mouseleave', () => {
          updateInteractiveStars(ratingInput.value);
       });
    }

    function updateInteractiveStars(val, isHover = false) {
       const starBtns = document.getElementById('star-interactive').querySelectorAll('.star-btn');
       starBtns.forEach(btn => {
          const btnVal = parseInt(btn.dataset.value);
          if (btnVal <= val) {
             btn.classList.add(isHover ? 'hover' : 'active');
             if(!isHover) btn.classList.remove('hover');
          } else {
             btn.classList.remove('hover', 'active');
          }
       });
    }
  }

  // Toast
  function showToast(msg, type = 'info') {
      const el = document.createElement('div');
      el.className = `toast toast-${type}`;
      el.innerHTML = `<span>${type === 'success' ? '‚úî' : type==='error'?'‚úñ':'‚Ñπ'}</span><p>${msg}</p>`;
      toastContainer.appendChild(el);
      requestAnimationFrame(() => el.classList.add('visible'));
      setTimeout(() => {
         el.classList.remove('visible');
         setTimeout(() => el.remove(), 300);
      }, 4000);
  }
</script>

<style is:global>
  /* --- LAYOUT & CONTAINERS --- */
  .comments-container {
      max-width: 800px;
      margin: 4rem auto;
      padding: 0 1rem;
      font-family: var(--font-body);
      color: var(--color-text-main);
  }

  .comments-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--color-border);
      padding-bottom: 1rem;
  }

  .header-title {
      display: flex;
      align-items: center;
      gap: 1rem;
  }

  .header-title h3 {
      font-size: 1.75rem;
      margin: 0;
  }

  .comment-count-pill {
      background: var(--color-surface-hover);
      color: var(--color-primary);
      padding: 0.25rem 0.75rem;
      border-radius: 99px;
      font-weight: 700;
      font-size: 0.9rem;
      border: 1px solid var(--color-border);
  }

  /* --- SORT SELECT --- */
  .sort-control {
      position: relative;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      padding: 0.25rem 0.5rem;
      border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .sort-select {
      background: transparent;
      border: none;
      color: var(--color-text-muted);
      font-size: 0.9rem;
      font-family: inherit;
      padding: 0.5rem 2rem 0.5rem 0.5rem;
      cursor: pointer;
      appearance: none;
      transition: color 0.2s;
  }

  .sort-select option {
      background: var(--color-surface);
      color: var(--color-text-main);
  }

  .sort-select:hover {
      color: var(--color-text-main);
  }
  
  .sort-select:focus {
     outline: none;
  }

  .sort-icon {
      position: absolute;
      right: 0.75rem;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: var(--color-text-muted);
      width: 14px;
      height: 14px;
  }

  /* --- GRID --- */
  .comments-grid {
      display: flex;
      flex-direction: column;
      gap: 3rem;
  }

  /* --- FORM CARD --- */
  .glass-card {
      background: var(--color-surface);
      border: 1px solid var(--color-primary-glow);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
  }
  
  /* Accent light effect */
  .glass-card::before {
     content: '';
     position: absolute;
     top: 0;
     left: 0;
     width: 100%;
     height: 4px;
     background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
     opacity: 0.6;
  }

  .card-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
  }

  .header-text h4 { margin: 0; font-size: 1.1rem; }
  .header-text p { margin: 0; color: var(--color-text-muted); font-size: 0.9rem; }

  .user-avatar {
     width: 48px;
     height: 48px;
     border-radius: 50%;
     object-fit: cover;
     border: 2px solid var(--color-primary);
  }

  .user-avatar-placeholder {
     width: 48px;
     height: 48px;
     border-radius: 50%;
     background: var(--color-surface-hover);
     color: var(--color-text-muted);
     display: flex;
     align-items: center;
     justify-content: center;
  }
  
  .user-avatar-placeholder svg { width: 24px; height: 24px; }

  /* --- INPUTS --- */
  .comment-form {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
  }

  .guest-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
  }

  @media (max-width: 600px) {
      .guest-inputs { grid-template-columns: 1fr; }
  }

  .input-group {
      position: relative;
  }

  .input-group input,
  .input-group textarea {
      width: 100%;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 1.5rem 1rem 0.75rem;
      color: var(--color-text-main);
      font-family: inherit;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      resize: vertical;
  }

  .input-group label {
      position: absolute;
      left: 1rem;
      top: 1.25rem;
      color: var(--color-text-dim);
      font-size: 0.95rem;
      pointer-events: none;
      transition: all 0.2s ease;
  }
  
  .input-group input:focus,
  .input-group textarea:focus {
      background: rgba(0,0,0,0.2);
      border-color: var(--color-primary);
      outline: none;
  }

  .input-group input:focus ~ label,
  .input-group input:not(:placeholder-shown) ~ label,
  .input-group textarea:focus ~ label,
  .input-group textarea:not(:placeholder-shown) ~ label {
      top: 0.5rem;
      font-size: 0.75rem;
      color: var(--color-primary);
      font-weight: 600;
  }

  /* --- ACTIONS --- */
  .form-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
  }

  .rating-picker {
      display: flex;
      align-items: center;
      gap: 0.75rem;
  }

  .rating-label {
      font-size: 0.9rem;
      color: var(--color-text-muted);
  }

  .stars-interactive {
      display: flex;
      gap: 0.25rem;
  }

  .star-btn {
      background: none;
      border: none;
      padding: 2px;
      cursor: pointer;
      color: var(--color-text-dim);
      transition: transform 0.2s;
  }

  .star-btn svg { width: 24px; height: 24px; }
  
  .star-btn.hover, .star-btn.active { color: #fbbf24; transform: scale(1.1); }

  .submit-btn {
      background: var(--color-primary);
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 99px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
  }

  .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
      filter: brightness(1.1);
  }

  .submit-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
  }

  /* --- COMMENTS LIST --- */
  .comments-list {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
  }

  .comment-card {
      display: flex;
      gap: 1.25rem;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05); /* Subtle border */
      border-radius: 16px;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: hidden;
  }

  .comment-card::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      opacity: 0;
      transition: opacity 0.3s;
  }

  .comment-card:hover {
      background: rgba(255, 255, 255, 0.04);
      border-color: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
  }
  
  .comment-card:hover::after {
      opacity: 1;
  }

  .card-side { flex-shrink: 0; }

  .avatar-circle {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #fff;
      text-transform: uppercase;
      font-size: 1.25rem;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border: 2px solid rgba(255,255,255,0.05);
  }
  
  .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }

  .card-main { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 0.5rem; }

  .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
  }

  .author-meta {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
  }

  .author-name {
      font-weight: 700;
      font-size: 1rem;
      color: var(--color-text-main);
      letter-spacing: -0.01em;
  }

  .mini-stars {
      display: flex;
      gap: 1px;
      color: #fbbf24;
      margin-top: 2px;
  }
  .mini-stars svg { width: 12px; height: 12px; color: rgba(255,255,255,0.15); }
  .mini-stars svg.filled { color: #f59e0b; filter: drop-shadow(0 0 2px rgba(245, 158, 11, 0.5)); }

  .meta-right {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.8rem;
      color: var(--color-text-muted);
  }
  
  .meta-right time {
      background: rgba(255,255,255,0.03);
      padding: 0.2rem 0.6rem;
      border-radius: 6px;
  }

  .delete-btn {
      background: transparent;
      border: none;
      color: var(--color-text-dim);
      padding: 6px;
      cursor: pointer;
      opacity: 0;
      transition: all 0.2s;
      border-radius: 6px;
  }

  .comment-card:hover .delete-btn { opacity: 1; }
  .delete-btn:hover { color: #ef4444; background: rgba(239, 68, 68, 0.1); transform: scale(1.05); }

  /* Like Btn */
  .like-btn {
      background: rgba(255,255,255,0.05);
      border: none;
      border-radius: 8px;
      padding: 0.4rem 0.6rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
      color: var(--color-text-muted);
      transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  
  .like-btn:hover {
      background: rgba(255,255,255,0.1);
      color: var(--color-text-main);
      transform: scale(1.05);
  }
  
  .like-btn.liked {
      background: rgba(236, 72, 153, 0.15); /* Pink tint */
      color: #ec4899;
  }
  
  .like-btn.liked svg {
      fill: currentColor;
      transform: scale(1.1);
  }

  .like-count {
      font-weight: 600;
      font-size: 0.85rem;
  }

  .comment-body {
      color: var(--color-text-dim);
      line-height: 1.6;
      font-size: 0.95rem;
      white-space: pre-wrap;
      word-break: break-word;
      padding-top: 0.25rem;
  }
  
  /* Make text brighter on hover for better readability */
  .comment-card:hover .comment-body {
      color: rgba(255,255,255,0.9);
      transition: color 0.3s ease;
  }

  /* --- STATES --- */
  .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      opacity: 0.8;
      background: rgba(255,255,255,0.02);
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,0.1);
  }
  .empty-icon { font-size: 3rem; margin-bottom: 1rem; display: inline-block; }
  .shadow-glow { filter: drop-shadow(0 0 15px rgba(139,92,246,0.5)); }

  /* Skeleton */
  .skeleton-wrapper { display: flex; flex-direction: column; gap: 1.5rem; }
  .skeleton-card { 
      display: flex; gap: 1rem; padding: 1.5rem; 
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 16px; 
  }
  .sk-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.1), rgba(255,255,255,0.05)); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
  .sk-content { flex: 1; display: flex; flex-direction: column; gap: 0.75rem; justify-content: center; }
  .sk-line { height: 12px; background: linear-gradient(90deg, rgba(255,255,255,0.05), rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border-radius: 4px; background-size: 200% 100%; animation: shimmer 1.5s infinite; }
  .w-30 { width: 30%; } .w-80 { width: 80%; } .w-60 { width: 60%; }
  
  @keyframes shimmer { 
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
  }

  /* Toast */
  .toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none; }
  .toast { 
     background: #18181b; 
     border: 1px solid var(--color-border); 
     padding: 1rem 1.5rem; 
     border-radius: 12px; 
     display: flex; 
     gap: 1rem; 
     align-items: center; 
     box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
     transform: translateY(20px); 
     opacity: 0; 
     transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
     color: #fff;
  }
  .toast.visible { transform: translateY(0); opacity: 1; }
  .toast-success { border-left: 4px solid #22c55e; }
  .toast-error { border-left: 4px solid #ef4444; }
  .toast-info { border-left: 4px solid var(--color-primary); }

  /* Animations */
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }
  .delay-100 { animation-delay: 0.1s; }
  .delay-200 { animation-delay: 0.2s; }
  
  .spinner {
     display: inline-block;
     width: 12px;
     height: 12px;
     border: 2px solid rgba(255,255,255,0.3);
     border-radius: 50%;
     border-top-color: #fff;
     animation: spin 1s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
