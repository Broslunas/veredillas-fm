---
interface Props {
  episodeSlug: string;
  className?: string;
}

const { episodeSlug, className = '' } = Astro.props;
---

<button 
  class={`favorite-btn ${className}`}
  data-episode-slug={episodeSlug}
  aria-label="Agregar a favoritos"
  title="Agregar a favoritos"
>
  <svg class="heart-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
  </svg>
  <span class="favorite-text">
    <span class="favorite-label">Favorito</span>
    <span class="favorite-count" data-count="0">0</span>
  </span>
</button>

<style is:global>
  .favorite-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    border: 2px solid rgba(139, 92, 246, 0.3);
    border-radius: 50px;
    background: rgba(139, 92, 246, 0.1);
    color: var(--color-text);
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .favorite-btn:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: rgba(139, 92, 246, 0.5);
    transform: translateY(-2px);
  }

  .favorite-btn.favorited {
    background: linear-gradient(135deg, #ec4899, #ef4444);
    border-color: #ef4444;
    color: white;
  }

  .favorite-btn.favorited:hover {
    background: linear-gradient(135deg, #db2777, #dc2626);
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
  }

  .heart-icon {
    width: 20px;
    height: 20px;
    transition: all 0.3s ease;
  }

  .favorite-btn.favorited .heart-icon {
    fill: currentColor;
    animation: heartBeat 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .favorite-btn:active .heart-icon {
    transform: scale(0.9);
  }

  @keyframes heartBeat {
    0%, 100% {
      transform: scale(1);
    }
    25% {
      transform: scale(1.3);
    }
    50% {
      transform: scale(1.1);
    }
  }

  .favorite-btn.loading {
    opacity: 0.6;
    cursor: wait;
    pointer-events: none;
  }

  .favorite-text {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 0.4rem;
    line-height: 1;
  }

  .favorite-label {
    font-size: 0.9rem;
  }

  .favorite-count {
    font-size: 0.85rem;
    opacity: 0.8;
    font-weight: 500;
    margin-left: 2px;
  }

  @media (max-width: 640px) {
    .favorite-text {
      display: none;
    }
    
    .favorite-btn {
      padding: 0.625rem;
      min-width: 44px;
      justify-content: center;
    }
  }
</style>

<script>
  // Load favorites and init buttons
  async function initFavoriteButtons() {
    try {
      // Get user's favorites
      const response = await fetch('/api/favorites/list');
      const data = await response.json();
      const favorites = data.favorites || [];

      // Mark favorited buttons and load counts
      const buttons = document.querySelectorAll('.favorite-btn');
      
      for (const button of buttons) {
        const slug = button.getAttribute('data-episode-slug');
        
        // Mark if favorited
        if (favorites.includes(slug)) {
          button.classList.add('favorited');
          button.setAttribute('aria-label', 'Quitar de favoritos');
          button.setAttribute('title', 'Quitar de favoritos');
        }

        // Load favorite count for this episode
        if (slug) {
          loadFavoriteCount(slug, button as HTMLElement);
        }

        // Add click handler
        button.addEventListener('click', async (e) => {
          e.preventDefault();
          await toggleFavorite(button as HTMLButtonElement);
        });
      }
    } catch (error) {
      console.error('Error loading favorites:', error);
    }
  }

  async function loadFavoriteCount(slug: string, button: HTMLElement) {
    try {
      const response = await fetch(`/api/favorites/count?slug=${encodeURIComponent(slug)}`);
      const data = await response.json();
      
      if (data.favoritesCount !== undefined) {
        updateCountDisplay(button, data.favoritesCount);
      }
    } catch (error) {
      console.error('Error loading favorite count:', error);
    }
  }

  function updateCountDisplay(button: HTMLElement, count: number) {
    const countEl = button.querySelector('.favorite-count');
    if (countEl) {
      countEl.textContent = count.toString();
      countEl.setAttribute('data-count', count.toString());
    }
  }

  async function toggleFavorite(button: HTMLButtonElement) {
    const slug = button.getAttribute('data-episode-slug');
    if (!slug) return;

    const wasFavorited = button.classList.contains('favorited');

    // Optimistic UI update
    button.classList.toggle('favorited');
    button.classList.add('loading');

    try {
      const response = await fetch('/api/favorites/toggle', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ episodeSlug: slug }),
      });

      const data = await response.json();

      if (!response.ok) {
        if (response.status === 401) {
          // Revert optimistic update immediately
          if (wasFavorited) {
            button.classList.add('favorited');
          } else {
            button.classList.remove('favorited');
          }
          
          if (window.showToast) {
            window.showToast('Inicia sesión para guardar favoritos ❤️', 'info');
          } else {
            alert('Debes iniciar sesión para guardar favoritos');
          }
          return;
        }
        throw new Error(data.error || 'Error al actualizar favorito');
      }

      // Update UI based on response
      if (data.isFavorite) {
        button.classList.add('favorited');
        button.setAttribute('aria-label', 'Quitar de favoritos');
        button.setAttribute('title', 'Quitar de favoritos');
        if (window.showToast) window.showToast('Añadido a favoritos', 'success');
      } else {
        button.classList.remove('favorited');
        button.setAttribute('aria-label', 'Agregar a favoritos');
        button.setAttribute('title', 'Agregar a favoritos');
        if (window.showToast) window.showToast('Eliminado de favoritos', 'info');
      }

      // Reload count from server to ensure accuracy
      await loadFavoriteCount(slug, button);
    } catch (error) {
      console.error('Error toggling favorite:', error);
      // Revert optimistic update on error
      if (wasFavorited) {
        button.classList.add('favorited');
      } else {
        button.classList.remove('favorited');
      }
      
      if (window.showToast) {
         window.showToast('Error al actualizar favorito', 'error');
      } else {
        alert('Error al actualizar favorito. Por favor, intenta de nuevo.');
      }
    } finally {
      button.classList.remove('loading');
    }
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initFavoriteButtons);
</script>
