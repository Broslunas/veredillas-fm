---
import { getCollection } from 'astro:content'; 
import EpisodeCard from './EpisodeCard.astro';

interface Props {
  currentSlug: string;
  tags: string[];
}

const { currentSlug, tags } = Astro.props;

const allEpisodes = await getCollection('episodios');

// Filter: exclude current, calculate matching score
const candidates = allEpisodes
  .filter((ep) => ep.slug !== currentSlug)
  .map((ep) => {
    const shared = ep.data.tags.filter((t) => tags.includes(t));
    return {
      ep,
      score: shared.length,
      // Tie-breaker: recency
      date: ep.data.pubDate.valueOf() 
    };
  });

// Sort: High score first, then new to old
candidates.sort((a, b) => {
  if (b.score !== a.score) return b.score - a.score;
  return b.date - a.date;
});

const relatedEpisodes = candidates.slice(0, 3).map(c => c.ep);
---

{relatedEpisodes.length > 0 && (
  <section class="related-section">
    <div class="container">
      <h2 class="section-title">También te podría interesar</h2>
      <div class="related-grid">
        {relatedEpisodes.map((ep) => (
          <div class="related-card-wrapper">
             <EpisodeCard post={ep} />
          </div>
        ))}
      </div>
    </div>
  </section>
)}

<style>
  .related-section {
    padding: var(--spacing-xl) 0;
    border-top: 1px solid var(--color-border);
    margin-top: var(--spacing-2xl);
  }

  .section-title {
    font-size: 1.75rem;
    margin-bottom: var(--spacing-lg);
    color: var(--color-text-main);
  }

  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--spacing-lg);
  }
</style>
