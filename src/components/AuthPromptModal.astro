---
// Server check to conditionally render HTML
const isLoggedIn = Astro.request.headers.get('cookie')?.includes('auth-token');

if (isLoggedIn) {
  return;
}
---

<div id="auth-prompt-modal" class="auth-prompt-backdrop" style="display: none;" aria-hidden="true">
    <div class="glass-panel auth-prompt-content">
        <button id="close-auth-prompt" class="close-btn" aria-label="Cerrar">&times;</button>
        
        <div class="prompt-header">
            <span class="logo-icon">‚ú®</span>
            <h3>¬°√önete a Veredillas FM!</h3>
        </div>
        
        <p class="prompt-message">
            ¬øDisfrutando del contenido? Inicia sesi√≥n para sacar el m√°ximo partido a tu experiencia.
        </p>
        
        <ul class="benefits-list">
            <li>
                <span class="icon">üéß</span>
                <span>Guarda tus episodios favoritos</span>
            </li>
            <li>
                <span class="icon">üèÜ</span>
                <span>Sube de nivel y gana insignias</span>
            </li>
            <li>
                <span class="icon">üìä</span>
                <span>Estad√≠sticas de escucha personalizadas</span>
            </li>
        </ul>
        
        <div class="prompt-actions">
            <a href="/login" class="btn-primary-glow">Iniciar Sesi√≥n / Registro</a>
            <button id="dismiss-auth-prompt" class="btn-text">Quiz√°s luego</button>
        </div>
    </div>
</div>

<style>
    .auth-prompt-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(8px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        opacity: 0;
        transition: opacity 0.5s ease;
    }
    
    .auth-prompt-backdrop.visible {
        opacity: 1;
    }

    .auth-prompt-content {
        max-width: 450px;
        width: 100%;
        background: rgba(20, 20, 25, 0.95);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 2.5rem;
        border-radius: 1.5rem;
        position: relative;
        text-align: center;
        transform: translateY(20px);
        transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        box-shadow: 0 20px 50px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1);
    }

    .auth-prompt-backdrop.visible .auth-prompt-content {
        transform: translateY(0);
    }

    .close-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        color: var(--color-text-muted);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
        line-height: 1;
        transition: color 0.2s;
        z-index: 10;
    }
    .close-btn:hover { color: white; }

    .logo-icon {
        font-size: 2.5rem;
        display: block;
        margin-bottom: 1rem;
        filter: drop-shadow(0 0 15px rgba(139, 92, 246, 0.6));
        animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }

    .prompt-header h3 {
        font-size: 1.75rem;
        margin: 0 0 0.5rem 0;
        font-weight: 800;
        background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .prompt-message {
        color: var(--color-text-muted);
        margin-bottom: 2rem;
        line-height: 1.6;
        font-size: 1rem;
    }

    .benefits-list {
        list-style: none;
        padding: 0;
        margin: 0 0 2.5rem 0;
        text-align: left;
    }

    .benefits-list li {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.75rem;
        color: var(--color-text-dim);
        font-size: 0.95rem;
        background: rgba(255,255,255,0.03);
        padding: 0.875rem 1rem;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.05);
        transition: background 0.3s;
    }

    .benefits-list li:hover {
        background: rgba(255,255,255,0.06);
    }
    
    .benefits-list .icon {
        font-size: 1.25rem;
        min-width: 24px;
        text-align: center;
    }

    .prompt-actions {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .btn-primary-glow {
        background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
        color: white;
        text-decoration: none;
        padding: 1.1rem;
        border-radius: 1rem;
        font-weight: 700;
        text-align: center;
        box-shadow: 0 4px 20px rgba(139, 92, 246, 0.4);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .btn-primary-glow:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(139, 92, 246, 0.6);
        filter: brightness(1.1);
    }

    .btn-text {
        background: none;
        border: none;
        color: var(--color-text-muted);
        font-size: 0.9rem;
        cursor: pointer;
        padding: 0.5rem;
        transition: color 0.2s;
        text-decoration: underline;
        opacity: 0.7;
    }
    .btn-text:hover { color: white; opacity: 1; }

</style>

<script>
    const SHOW_DELAY = 30000; 
    const STORAGE_KEY = 'veredillas_auth_prompt_dismissed';

    function initAuthPrompt() {
        // Double check cookies client side to be sure (using client readable cookie)
        if (document.cookie.includes('user-session')) return;

        // Check if user dismissed it in this session
        const dismissed = sessionStorage.getItem(STORAGE_KEY);
        if (dismissed) return;

        // We use a timeout. We should clear it on navigation if SPA, but 
        // Astro page transitions might keep scripts running or re-run them.
        // We'll attach it to window to be able to clear it if needed, or just let it run.
        // With ViewTransitions, specific page load events fire.
        
        // Prevent multiple timeouts if user navigates fast
        if ((window as any).authPromptTimeout) clearTimeout((window as any).authPromptTimeout);

        (window as any).authPromptTimeout = setTimeout(() => {
            const modal = document.getElementById('auth-prompt-modal');
            // Check again before showing
            if (modal && !document.cookie.includes('user-session') && !sessionStorage.getItem(STORAGE_KEY)) {
                modal.style.display = 'flex';
                // Trigger reflow for transition
                modal.offsetHeight; 
                modal.classList.add('visible');
            }
        }, SHOW_DELAY);
    }
    
    function dismissPrompt() {
        const modal = document.getElementById('auth-prompt-modal');
        if (modal) {
            modal.classList.remove('visible');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 500);
            sessionStorage.setItem(STORAGE_KEY, 'true');
        }
    }

    // Initialize on load
    document.addEventListener('astro:page-load', initAuthPrompt);
    document.addEventListener('DOMContentLoaded', initAuthPrompt);

    // Event Delegation
    document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (!target) return;
        
        if (target.id === 'close-auth-prompt' || target.id === 'dismiss-auth-prompt') {
            dismissPrompt();
        }
        
        if (target.id === 'auth-prompt-modal') {
             dismissPrompt();
        }
    });
</script>
