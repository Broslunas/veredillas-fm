---
// src/components/TrendingEpisodes.astro
---

<section id="trending-section" class="trending-section">
  <!-- Background Elements -->
  <div class="glow-bg glow-purple"></div>
  <div class="glow-bg glow-blue"></div>

  <div class="container">
    <div class="section-header">
      <h2 class="trending-title">
        Tendencias
      </h2>
      
      <!-- Time Period Toggle -->
      <div class="toggle-container">
        <button id="trend-week-btn" class="toggle-btn active">
          Semana
        </button>
        <button id="trend-month-btn" class="toggle-btn">
          Mes
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="trending-loading" class="trending-grid loading-state">
        {[1,2,3].map(i => (
            <div class="skeleton-card"></div>
        ))}
    </div>

    <!-- Content Grid -->
    <div id="trending-grid" class="trending-grid hidden">
        <!-- Filled by JS -->
    </div>

  </div>
</section>

<script>
  let currentPeriod = 'week';
  
  const section = document.getElementById('trending-section');
  const grid = document.getElementById('trending-grid');
  const loading = document.getElementById('trending-loading');
  const btnWeek = document.getElementById('trend-week-btn');
  const btnMonth = document.getElementById('trend-month-btn');

  async function fetchTrending(period) {
    if(!grid || !loading || !section) return;
    
    // UI Loading
    loading.classList.remove('hidden');
    grid.classList.add('hidden');
    // Ensure section is visible while loading (if it was hidden before)
    section.style.display = ''; 
    
    try {
        const res = await fetch(`/api/episodes/trending?period=${period}`);
        const data = await res.json();
        
        loading.classList.add('hidden');
        
        if (!data || data.length === 0) {
            // No data -> Hide the entire section
            section.style.display = 'none';
            return;
        }
        
        renderTrending(data);
        grid.classList.remove('hidden');
        
    } catch(e) {
        console.error("Error fetching trending:", e);
        loading.classList.add('hidden');
        // Error -> Hide the entire section
        section.style.display = 'none';
    }
  }

  function renderTrending(items) {
      if(!grid) return;
      grid.innerHTML = '';
      
      items.forEach((item, index) => {
          const rank = index + 1;
          const isTop3 = rank <= 3;
          
          const card = document.createElement('a');
          card.href = `/ep/${item.slug}`;
          card.className = `trending-card`;
          
          card.innerHTML = `
            <!-- Rank Badge -->
            <div class="rank-badge ${isTop3 ? 'top-rank' : ''}">
                ${rank}
            </div>
            
            <!-- Image -->
            <div class="card-image-wrapper">
                <img src="${item.image || '/logo.png'}" alt="${item.title}" class="card-image" loading="lazy" />
                <div class="image-overlay"></div>
            </div>
            
            <!-- Info -->
            <div class="card-info">
                <h3 class="card-title" title="${item.title}">
                    ${item.title}
                </h3>
                <p class="card-author">${item.author || 'Veredillas FM'}</p>
                
                <div class="card-meta">
                    <span class="meta-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                        ${item.count}
                    </span>
                    <span class="meta-duration">
                       ${item.duration ? Math.floor(item.duration/60) + ' min' : ''}
                    </span>
                </div>
            </div>
            
            <!-- Play Action -->
            <div class="play-action" aria-label="Reproducir">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            </div>
          `;
          
          grid.appendChild(card);
      });
  }

  // Event Listeners
  if(btnWeek && btnMonth) {
      btnWeek.onclick = () => {
          if(currentPeriod === 'week') return;
          currentPeriod = 'week';
          updateToggleUI();
          fetchTrending('week');
      };
      
      btnMonth.onclick = () => {
          if(currentPeriod === 'month') return;
          currentPeriod = 'month';
          updateToggleUI();
          fetchTrending('month');
      };
  }

  function updateToggleUI() {
      if(currentPeriod === 'week') {
          btnWeek?.classList.add('active');
          btnMonth?.classList.remove('active');
      } else {
          btnMonth?.classList.add('active');
          btnWeek?.classList.remove('active');
      }
  }

  // Init
  fetchTrending('week');

</script>

<style>
    .trending-section {
        padding: 4rem 0;
        position: relative;
        overflow: hidden;
        contain: content;
    }

    /* Background Elements */
    .glow-bg {
        position: absolute;
        border-radius: 50%;
        filter: blur(80px);
        z-index: -10;
        opacity: 0.1;
    }

    .glow-purple {
        top: 0;
        right: 0;
        width: 16rem; /* 64 */
        height: 16rem;
        background-color: #8b5cf6; /* purple-500 */
    }

    .glow-blue {
        bottom: 0;
        left: 0;
        width: 24rem; /* 96 */
        height: 24rem;
        background-color: #3b82f6; /* blue-500 */
    }

    .container {
        width: 100%;
        margin-left: auto;
        margin-right: auto;
        padding-left: 1rem;
        padding-right: 1rem;
        max-width: 1280px; /* xl */
    }

    .section-header {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    @media (min-width: 768px) {
        .section-header {
            flex-direction: row;
        }
    }

    .trending-title {
        font-size: 1.875rem; /* 3xl */
        font-weight: 700;
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
        background-image: linear-gradient(to right, #ffffff, #e9d5ff); /* purple-200 */
    }

    @media (min-width: 768px) {
        .trending-title {
            font-size: 2.25rem; /* 4xl */
        }
    }

    /* Toggle Switch */
    .toggle-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background-color: rgba(255, 255, 255, 0.05);
        padding: 0.25rem;
        border-radius: 9999px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(4px);
        margin-top: 1rem;
    }

    @media (min-width: 768px) {
        .toggle-container {
            margin-top: 0;
        }
    }

    .toggle-btn {
        padding: 0.375rem 1rem;
        border-radius: 9999px;
        font-size: 0.875rem; /* sm */
        font-weight: 500;
        transition: all 0.3s ease;
        color: #9ca3af; /* gray-400 */
        background: transparent;
        border: none;
        cursor: pointer;
    }

    .toggle-btn:hover {
        color: white;
        background-color: rgba(255, 255, 255, 0.05);
    }

    .toggle-btn.active {
        background-color: #7c3aed; /* purple-600 */
        color: white;
        box-shadow: 0 10px 15px -3px rgba(124, 58, 237, 0.2);
    }

    /* Grid Layout */
    .trending-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    @media (min-width: 768px) {
        .trending-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (min-width: 1280px) {
        .trending-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    .hidden {
        display: none !important;
    }

    /* Loading / Skeleton */
    .skeleton-card {
        height: 6rem;
        background-color: rgba(255, 255, 255, 0.05);
        border-radius: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Card Styles */
    /* Needs to be global or ::global because generated by JS, 
       BUT since it's inside this component and scoped style doesn't penetrate JS html automatically unless using :global
    */
    :global(.trending-card) {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem;
        border-radius: 0.75rem;
        border: 1px solid rgba(255, 255, 255, 0.05);
        background-color: rgba(255, 255, 255, 0.05);
        cursor: pointer;
        overflow: hidden;
        position: relative;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    :global(.trending-card:hover) {
        background-color: rgba(255, 255, 255, 0.1);
        border-color: rgba(168, 85, 247, 0.3); /* purple-500/30 */
        box-shadow: 0 10px 15px -3px rgba(168, 85, 247, 0.1);
    }

    /* Rank Badge */
    :global(.rank-badge) {
        flex-shrink: 0;
        width: 2rem;
        text-align: center;
        font-weight: 700;
        font-size: 1.25rem;
        color: #6b7280; /* gray-500 */
    }

    :global(.top-rank) {
        color: #a78bfa; /* purple-400 */
    }

    /* Image */
    :global(.card-image-wrapper) {
        position: relative;
        width: 4rem;
        height: 4rem;
        border-radius: 0.5rem;
        overflow: hidden;
        flex-shrink: 0;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    :global(.card-image) {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    :global(.trending-card:hover .card-image) {
        transform: scale(1.1);
    }

    :global(.image-overlay) {
        position: absolute;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.2);
        transition: background-color 0.3s ease;
    }

    :global(.trending-card:hover .image-overlay) {
        background-color: transparent;
    }

    /* Info */
    :global(.card-info) {
        flex: 1;
        min-width: 0;
    }

    :global(.card-title) {
        color: white;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding-right: 0.5rem;
        transition: color 0.3s ease;
        margin: 0;
        font-size: 1rem;
    }

    :global(.trending-card:hover .card-title) {
        color: #d8b4fe; /* purple-300 */
    }

    :global(.card-author) {
        font-size: 0.75rem;
        color: #9ca3af; /* gray-400 */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin: 0.125rem 0 0 0;
    }

    :global(.card-meta) {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-top: 0.375rem;
        opacity: 0.8;
    }

    :global(.meta-badge) {
        font-size: 0.625rem;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        background-color: rgba(0, 0, 0, 0.2);
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
    }

    :global(.meta-duration) {
        font-size: 0.625rem;
        color: #6b7280;
    }

    /* Play Button */
    :global(.play-action) {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 9999px;
        background-color: #7c3aed;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        opacity: 0;
        transform: translateX(1rem);
        transition: all 0.3s ease;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    :global(.trending-card:hover .play-action) {
        opacity: 1;
        transform: translateX(0);
        background-color: #8b5cf6;
        transform: scale(1.05);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 0;
        color: #6b7280;
    }
</style>
