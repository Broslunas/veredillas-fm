---
// src/components/MiniPlayer.astro
// Persisted player component that listens for 'play-episode' events
---

<!-- Mini Player (Floating) -->
<div id="mini-player" class="mini-player hidden">
  <div class="player-wrapper glass-panel">
      <div id="player-placeholder"></div>
      
      <!-- Controls for Mini Player -->
      <div class="mini-controls">
          <button id="mini-share-btn" class="control-btn" aria-label="Compartir en Historia" style="margin-right: 5px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
          </button>
          <button id="expand-player" class="control-btn" aria-label="Pantalla completa">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
          </button>
          <button id="close-player" class="control-btn close" aria-label="Cerrar reproductor">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
          </button>
      </div>
  </div>
</div>

<!-- Immersive Overlay (Cinema Mode) -->
<div id="immersive-player" class="immersive-overlay hidden">
    <div class="background-glow"></div>
    <div class="immersive-container">
        
        <div class="immersive-controls-top">
             <button id="share-story-btn" class="icon-btn" aria-label="Compartir en Historia">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
            </button>
            <button id="collapse-player" class="icon-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"/></svg>
            </button>
        </div>

        <div class="immersive-content">
            <div class="immersive-cover-wrapper">
                <img id="immersive-cover" src="/logo.png" alt="Cover" />
                <div class="vinyl-grooves"></div>
            </div>
            
            <div class="immersive-meta">
                <h2 id="immersive-title">Título del Episodio</h2>
                <p id="immersive-author">Veredillas FM</p>
            </div>

            <canvas id="audio-visualizer"></canvas>
        </div>
    </div>
</div>

<!-- Hidden Story Card Template -->
<!-- Story Customization Modal -->
<div id="story-modal" class="story-modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-content-wrapper">
        <div class="modal-preview-column">
             <div id="story-card-preview" class="story-card scale-preview">
                <div class="story-bg"></div>
                <div class="story-content">
                    <div class="story-header">
                        <span class="story-brand">Veredillas FM</span>
                    </div>
                    <div class="story-cover-container">
                         <img id="story-cover" src="/logo.png" crossorigin="anonymous" />
                         <div class="story-vinyl-shine"></div>
                    </div>
                    <div class="story-meta">
                        <h1 id="story-title">Título del Episodio</h1>
                        <p id="story-author">Veredillas FM</p>
                    </div>
                    <div class="story-wave-container">
                         <canvas id="story-wave" width="400" height="100"></canvas>
                    </div>
                </div>
                <div class="story-footer">
                    <div class="story-listen-tag">Escúchalo ahora</div>
                    <div id="story-qr-code" class="story-qr"></div>
                </div>
            </div>
        </div>

        <div class="modal-controls-column">
            <h3>Personalizar Historia</h3>
            <p>Elige un estilo para tu historia antes de compartir.</p>
            
            <div class="control-group">
                <label>Fondo</label>
                <div class="color-options">
                    <button class="color-btn active" data-style="gradient" style="background: linear-gradient(135deg, #333, #000);"></button>
                    <button class="color-btn" data-style="solid" style="background: #111;"></button>
                    <button class="color-btn" data-style="light" style="background: #f5f5f5;"></button>
                </div>
            </div>

            <div class="modal-actions">
                <button id="cancel-story" class="btn-cancel">Cancelar</button>
                <button id="download-story-final" class="btn-download">
                    Descargar Imagen
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    import { FastAverageColor } from 'fast-average-color';
    // @ts-ignore
    import { toPng } from 'html-to-image';
    // @ts-ignore
    import QRCode from 'qrcode';

    declare global {
        interface Window {
            hasGlobalPlayerListener: boolean;
            playerCurrentUrl: string | null;
            playerMeta: { title: string, image: string, author: string } | null;
            visualizerInterval: number;
        }
    }

    // We use a global flag to prevent attaching GLOBAL event listeners (like 'play-episode' on document) multiple times.
    // However, 'astro:page-load' needs to be handled carefully.

        window.playerCurrentUrl = null;
        window.playerMeta = null;
        
        // Modules are cached, so these run once.
        const fac = new FastAverageColor();

        // ---- Visualizer Logic (Simulated) ----
        const initVisualizer = () => {
             const canvas = document.getElementById('audio-visualizer') as HTMLCanvasElement;
             if (!canvas) return;
             
             const ctx = canvas.getContext('2d');
             if (!ctx) return;

             // Resize
             const resize = () => {
                 canvas.width = canvas.offsetWidth;
                 canvas.height = canvas.offsetHeight;
             };
             window.addEventListener('resize', resize);
             resize();

             if (window.visualizerInterval) cancelAnimationFrame(window.visualizerInterval);

             const bars = 60;
             let time = 0;

             const draw = () => {
                 ctx.clearRect(0, 0, canvas.width, canvas.height);
                 
                 const width = canvas.width / bars;
                 const center = canvas.height / 2;
                 
                 ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--color-primary');
                 
                 for (let i = 0; i < bars; i++) {
                     // Simulating wave data based on time and index
                     const relX = i / bars; // 0 to 1
                     
                     // Complex wave function to look like speech/music
                     const h1 = Math.sin(time * 0.1 + i * 0.2) * 50; 
                     const h2 = Math.cos(time * 0.2 + i * 0.1) * 30;
                     const noise = Math.random() * 20;
                     
                     // Shape envelope (taper at ends)
                     const envelope = Math.sin(relX * Math.PI);
                     
                     const height = Math.abs((h1 + h2 + noise) * envelope * 2); // Scale up
                     
                     const x = i * width;
                     const y = center - height / 2;
                     
                     // Rounded bars
                     ctx.beginPath();
                     ctx.roundRect(x + 2, y, width - 4, height, 4);
                     ctx.fill();
                 }
                 
                 time += 0.5;
                 window.visualizerInterval = requestAnimationFrame(draw);
             };
             
             draw();
        };

        // ---- Ambient Mode Logic ----
        const updateAmbientTheme = async (imageUrl: string) => {
            try {
                const color = await fac.getColorAsync(imageUrl);
                document.documentElement.style.setProperty('--color-primary-glow', color.rgba);
                // Also update the glow in immersive mode
                const glow = document.querySelector('.background-glow') as HTMLElement;
                if (glow) {
                    glow.style.background = `radial-gradient(circle at center, ${color.rgba}, transparent 70%)`;
                }
                
                // Update Story Card Background
                const storyBg = document.querySelector('.story-bg') as HTMLElement;
                if (storyBg) {
                    storyBg.style.background = `linear-gradient(180deg, ${color.hex} 0%, #000000 100%)`;
                }
            } catch (e) {
                console.log("Ambient color failed", e);
            }
        };

        // Function to update position and metadata
        const updatePlayerState = () => {
            const player = document.getElementById('mini-player');
            const placeholder = document.getElementById('episode-player-placeholder');
            const container = document.getElementById('player-placeholder');
            const immersiveOverlay = document.getElementById('immersive-player');
            
            // Elements to update in Immersive
            const immTitle = document.getElementById('immersive-title');
            const immAuthor = document.getElementById('immersive-author');
            const immCover = document.getElementById('immersive-cover') as HTMLImageElement;

            if (!player || !container) return;

            if (placeholder) {
                // INLINE MODE CANDIDATE
                const url = placeholder.getAttribute('data-spotify-url');
                const title = placeholder.getAttribute('data-title');
                const image = placeholder.getAttribute('data-image');
                const author = placeholder.getAttribute('data-author');

                // Update Meta Global
                if (title) window.playerMeta = { title, image: image || '/logo.png', author: author || 'Veredillas FM' };

                // CHECK CONFLICT
                if (window.playerCurrentUrl && url && window.playerCurrentUrl !== url) {
                    // CONFLICT: Show Floating Player
                    if (container.hasChildNodes()) {
                        player.classList.remove('inline', 'hidden');
                        player.classList.add('floating', 'visible');
                        
                        // Setup Floating Styles
                        player.style.position = 'fixed';
                        player.style.top = 'auto';
                        player.style.bottom = '0';
                        player.style.left = '0';
                        player.style.width = '100%';
                        player.style.height = 'auto';
                        
                        const closeBtn = document.getElementById('close-player');
                        if(closeBtn) closeBtn.style.display = 'flex';
                        
                        document.body.style.paddingBottom = '100px';
                        
                        // Populate Immersive if needed
                        if (immTitle && window.playerMeta) {
                            immTitle.innerText = window.playerMeta.title;
                            if (immAuthor) immAuthor.innerText = window.playerMeta.author;
                            immCover.src = window.playerMeta.image;
                            updateAmbientTheme(window.playerMeta.image);
                        }
                    }

                    // Render Prompt in Placeholder
                    if (!placeholder.hasAttribute('data-rendered-prompt')) {
                         placeholder.setAttribute('data-rendered-prompt', 'true');
                         placeholder.innerHTML = `
                            <div class="conflict-wrapper" style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; background: rgba(255,255,255,0.03); border-radius:12px; border: 1px dashed rgba(255,255,255,0.1);">
                                <p style="margin:0; color: #a1a1aa; font-size: 0.95rem; font-weight: 500;">Estás escuchando otro episodio</p>
                                <button id="force-play-btn" style="cursor: pointer; background: white; color: black; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem;">
                                    Reproducir este en su lugar
                                </button>
                            </div>
                        `;
                        
                        const btn = placeholder.querySelector('#force-play-btn');
                        if(btn) {
                            btn.addEventListener('click', () => {
                                window.playerCurrentUrl = null; 
                                container.innerHTML = '';
                                updatePlayerState();
                            });
                        }
                    }
                    return; 
                }
                
                // NO CONFLICT -> Inline Logic
                if (url && (window.playerCurrentUrl !== url)) {
                    window.playerCurrentUrl = url;
                    if(title) window.playerMeta = { title, image: image || '/logo.png', author: author || 'Veredillas FM' };
                    
                    // Update Ambient
                    if (image) updateAmbientTheme(image);
                    
                    // Inject Iframe
                    let finalUrl = url;
                    try {
                         const urlObj = new URL(url);
                         if (!urlObj.pathname.includes('/embed/')) {
                              const segments = urlObj.pathname.split('/').filter(Boolean);
                              if (segments[0] !== 'embed') finalUrl = `${urlObj.origin}/embed${urlObj.pathname}`;
                         }
                    } catch(e) {}
                    
                    container.innerHTML = `
                        <iframe 
                        id="spotify-iframe"
                        style="border-radius:12px" 
                        src="${finalUrl}?autoplay=0" 
                        width="100%" 
                        height="100%" 
                        frameBorder="0"
                        scrolling="no"
                        allowfullscreen="" 
                        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                        loading="lazy">
                    </iframe>
                    `;
                }

                // Inline CSS
                const rect = placeholder.getBoundingClientRect();
                const scrollX = window.scrollX || window.pageXOffset;
                const scrollY = window.scrollY || window.pageYOffset;

                player.classList.remove('floating', 'hidden');
                player.classList.add('inline', 'visible');

                player.style.position = 'absolute';
                player.style.top = `${rect.top + scrollY}px`;
                player.style.left = `${rect.left + scrollX}px`;
                player.style.width = `${rect.width}px`;
                player.style.height = `${rect.height}px`;
                
                // Hide controls in inline
                const ctrls = player.querySelector('.mini-controls') as HTMLElement;
                if(ctrls) ctrls.style.display = 'none';

                document.body.style.paddingBottom = '0';

            } else {
                // FLOATING MODE (Navigating other pages)
                if (container.hasChildNodes()) {
                    player.classList.remove('inline', 'hidden');
                    player.classList.add('floating', 'visible');

                    player.style.position = 'fixed';
                    player.style.top = 'auto';
                    player.style.bottom = '0';
                    player.style.left = '0';
                    player.style.width = '100%';
                    player.style.height = 'auto';

                    const ctrls = player.querySelector('.mini-controls') as HTMLElement;
                    if(ctrls) ctrls.style.display = 'flex';

                    document.body.style.paddingBottom = '100px';

                    // Update Immersive Data if available
                    if (window.playerMeta && immTitle) {
                         immTitle.innerText = window.playerMeta.title;
                         if (immAuthor) immAuthor.innerText = window.playerMeta.author;
                         immCover.src = window.playerMeta.image;
                         updateAmbientTheme(window.playerMeta.image);
                    }
                } else {
                    player.classList.add('hidden');
                    player.classList.remove('visible');
                    document.body.style.paddingBottom = '0';
                }
            }
        };

        // Listeners

        window.addEventListener('resize', updatePlayerState);
        
        // Custom Play Event
        document.addEventListener('play-episode', ((e: Event) => {
             const customEvent = e as CustomEvent;
             const { url, title, image, author } = customEvent.detail;
             
             const container = document.getElementById('player-placeholder');
             
             if (container) {
                 window.playerCurrentUrl = url;
                 if (title) window.playerMeta = { title, image, author };
                 
                 // Reuse insertion logic
                 // ... simplified for brevity, assume updatePlayerState handles if we set the placeholder attrs conceptually or just direct
                 // Since we don't have a placeholder on non-ep pages, we must manually inject into floating
                 // But wait, play-episode usually comes from clicking something.
                 // If we are on a listing page, there is no placeholder.
                 
                 // Direct Inject
                  let finalUrl = url;
                    try {
                         const urlObj = new URL(url);
                         if (!urlObj.pathname.includes('/embed/')) {
                              const segments = urlObj.pathname.split('/').filter(Boolean);
                              if (segments[0] !== 'embed') finalUrl = `${urlObj.origin}/embed${urlObj.pathname}`;
                         }
                    } catch(e) {}
                 
                 container.innerHTML = `
                         <iframe 
                         id="spotify-iframe"
                         style="border-radius:12px" 
                         src="${finalUrl}?autoplay=1" 
                         width="100%" 
                         height="100%" 
                         frameBorder="0" 
                         scrolling="no"
                         allowfullscreen="" 
                         allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                         loading="lazy">
                     </iframe>
                  `;
                  
                  if(image) updateAmbientTheme(image);
                  updatePlayerState();
             }
        }));

        // Custom Share Story Event
        document.addEventListener('share-story', ((e: Event) => {
             const customEvent = e as CustomEvent;
             const { title, image, author } = customEvent.detail || {};
             
             if (title && image) {
                 window.playerMeta = { title, image, author: author || 'Veredillas FM' };
                 updateAmbientTheme(image);
             }
             openStoryModal();
        }) as EventListener);

        // --- STORY LOGIC ---
        
        let extractedColor: any = null;

        const openStoryModal = async () => {
             const modal = document.getElementById('story-modal');
             if (!modal || !window.playerMeta) return;

             // Populate Data
             const sCover = document.getElementById('story-cover') as HTMLImageElement;
             const sTitle = document.getElementById('story-title');
             const sAuthor = document.getElementById('story-author');
             
             if (sCover) sCover.src = window.playerMeta.image;
             if (sTitle) sTitle.innerText = window.playerMeta.title;
             if (sAuthor) sAuthor.innerText = window.playerMeta.author;

             // 2. Generate QR Code
             const qrContainer = document.getElementById('story-qr-code');
             if (qrContainer && QRCode) {
                 const urlToShare = window.location.href;
                 try {
                     const qrDataUrl = await QRCode.toDataURL(urlToShare, { margin: 1, color: { dark: '#000', light: '#FFF' } });
                     qrContainer.innerHTML = `<img src="${qrDataUrl}" style="width:100%; height:100%; border-radius: 8px;" />`;
                 } catch (err) {
                     console.error(err);
                 }
             }

             // 3. Draw Static Wave
             const waveCanvas = document.getElementById('story-wave') as HTMLCanvasElement;
             if (waveCanvas) {
                 const ctx = waveCanvas.getContext('2d');
                 if (ctx) {
                     ctx.clearRect(0,0, waveCanvas.width, waveCanvas.height);
                     ctx.fillStyle = 'rgba(255,255,255,0.8)';
                     const bars = 40;
                     const width = waveCanvas.width / bars;
                     for(let i=0; i<bars; i++) {
                         const h = Math.random() * waveCanvas.height * 0.8 + 10;
                         const x = i * width;
                         const y = (waveCanvas.height - h)/2;
                         ctx.fillRect(x + 2, y, width - 4, h);
                     }
                 }
             }
             
             // Get Ambient Color
             try {
                extractedColor = await fac.getColorAsync(window.playerMeta.image);
                updateCardStyle('gradient');
             } catch(e) {}

             modal.classList.remove('hidden');
        };

        const closeStoryModal = () => {
             const modal = document.getElementById('story-modal');
             if(modal) modal.classList.add('hidden');
        };

        const updateCardStyle = (style: string) => {
             const storyBg = document.querySelector('.story-bg') as HTMLElement;
             const title = document.getElementById('story-title');
             
             if (!storyBg || !extractedColor) return;

             if (style === 'gradient') {
                 storyBg.style.background = `linear-gradient(180deg, ${extractedColor.hex} 0%, #000000 100%)`;
                 if(title) title.style.color = 'white';
             } else if (style === 'solid') {
                 storyBg.style.background = extractedColor.hex;
                 if(title) title.style.color = 'white';
             } else if (style === 'light') {
                 storyBg.style.background = '#f5f5f5';
                 if(title) title.style.color = 'black';
             }
        };

        const downloadStoryImage = async () => {
             const card = document.getElementById('story-card-preview');
             if (!card || !toPng) return;
             
             const originalTransform = card.style.transform;
             card.style.transform = 'none'; // Reset scale for capture
             
             try {
                const dataUrl = await toPng(card, { cacheBust: true, pixelRatio: 2 });
                const link = document.createElement('a');
                link.download = `veredillas-story-${Date.now()}.png`;
                link.href = dataUrl;
                link.click();
             } catch (err) {
                 console.error('Could not generate story image', err);
             } finally {
                 card.style.transform = originalTransform;
             }
        };

        // Modal Listeners
        document.addEventListener('click', (e) => {
            const target = e.target as HTMLElement;
            if (target.id === 'cancel-story' || target.classList.contains('modal-backdrop')) {
                closeStoryModal();
            }
            if (target.id === 'download-story-final') {
                downloadStoryImage();
            }
            if (target.classList.contains('color-btn')) {
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                target.classList.add('active');
                const style = target.getAttribute('data-style');
                if(style) updateCardStyle(style);
            }
        });

        // Close logic
         document.addEventListener('click', (e: Event) => {
            const target = e.target as HTMLElement;
            if (target && target.closest('#close-player')) {
                const player = document.getElementById('mini-player');
                const container = document.getElementById('player-placeholder');
                if (player) {
                    player.classList.remove('visible');
                    document.body.style.paddingBottom = '0';
                    setTimeout(() => {
                        player.classList.add('hidden');
                        if (container) container.innerHTML = '';
                        window.playerCurrentUrl = null;
                        window.playerMeta = null;
                        // Close immersive if open
                        document.getElementById('immersive-player')?.classList.add('hidden');
                    }, 300);
                }
            }
            
            // Expand
            if (target && target.closest('#expand-player')) {
                const immersive = document.getElementById('immersive-player');
                if (immersive) {
                    immersive.classList.remove('hidden');
                    initVisualizer();
                }
            }

            // Collapse
            if (target && target.closest('#collapse-player')) {
                 const immersive = document.getElementById('immersive-player');
                 if (immersive) immersive.classList.add('hidden');
            }

            // Custom Share Story Event
            if (target && (target.closest('#share-story-btn') || target.closest('#mini-share-btn'))) {
                openStoryModal();
            }
        });



    
    // Auto-run setup (MPA mode)
    document.addEventListener('DOMContentLoaded', updatePlayerState);
</script>

<style>
  .mini-player {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 9999;
    padding: 0;
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  
  .mini-player.hidden {
      display: none;
      transform: translateY(120%);
  }
  
  .mini-player.visible {
      display: block;
      transform: translateY(0);
  }

  .player-wrapper {
    width: 100%;
    height: 100%;
    background: #000;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    position: relative;
    overflow: hidden;
  }
  
  .mini-player.floating .player-wrapper {
       max-width: 600px;
       margin: 0 auto 10px; /* margin bottom for floating */
       height: 152px !important;
       border: 1px solid rgba(255,255,255,0.1);
  }

  .mini-controls {
      position: absolute;
      top: 5px;
      right: 5px;
      display: none; /* Hidden by default (inline) */
      gap: 5px;
      z-index: 20;
  }

  .control-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      backdrop-filter: blur(4px);
      transition: all 0.2s;
  }

  .control-btn:hover {
      background: white;
      color: black;
  }

  /* Inline Specifics */
  .mini-player.inline {
      padding: 0;
      z-index: 10; 
      box-shadow: none;
  }
  .mini-player.inline .player-wrapper {
      background: transparent;
      box-shadow: none;
      border: none;
      max-width: none;
      border-radius: 12px;
      height: 100%;
  }

  #player-placeholder {
      width: 100%;
      height: 100%;
  }
  
  :global(#spotify-iframe) {
      width: 100% !important;
      height: 100% !important;
      overflow: hidden !important;
      border: none !important;
  }

  /* IMMERSIVE MODE */
  .immersive-overlay {
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: #050505;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease;
  }

  .immersive-overlay:not(.hidden) {
      opacity: 1;
      pointer-events: auto;
  }

  .immersive-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2;
  }

  .background-glow {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100vw;
      height: 100vh;
      background: radial-gradient(circle at center, var(--color-primary-glow), transparent 70%);
      opacity: 0.3;
      z-index: 1;
      pointer-events: none;
  }

  .immersive-content {
      text-align: center;
      width: 100%;
      max-width: 500px;
      padding: 20px;
  }

  .immersive-cover-wrapper {
      width: 300px;
      height: 300px;
      margin: 0 auto 30px;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      position: relative;
      animation: float 6s ease-in-out infinite;
  }

  .immersive-cover-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }

  .immersive-meta h2 {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: linear-gradient(to bottom, #fff, #aaa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
  }
  
  .immersive-meta p {
      font-size: 1.2rem;
      color: var(--color-text-muted);
      margin-bottom: 2rem;
  }

  #audio-visualizer {
      width: 100%;
      height: 100px;
      margin-top: 20px;
      opacity: 0.8;
  }

  .collapse-btn {
      position: absolute;
      top: 40px;
      right: 40px;
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      z-index: 10;
  }
  
  .collapse-btn:hover {
      background: rgba(255,255,255,0.2);
  }
</style>

<style>
  /* STORY CARD STYLES */
  .story-card {
      width: 540px;
      height: 960px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      padding: 60px 40px;
      font-family: 'Inter', sans-serif;
  }
  
  .story-bg {
      position: absolute;
      inset: 0;
      background: #111;
      z-index: 0;
  }
  
  .story-content {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      flex: 1;
      justify-content: center;
  }
  
  .story-header {
      width: 100%;
      text-align: center;
      margin-bottom: 40px;
  }
  
  .story-brand {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 2px;
      color: rgba(255,255,255,0.6);
      text-transform: uppercase;
  }
  
  .story-cover-container {
      width: 400px;
      height: 400px;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 30px 80px rgba(0,0,0,0.5);
      position: relative;
      margin-bottom: 50px;
      border: 1px solid rgba(255,255,255,0.1);
  }
  
  .story-cover-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }
  
  .story-meta {
      text-align: center;
  }
  
  .story-meta h1 {
      font-size: 2.5rem;
      font-weight: 800;
      color: white;
      margin-bottom: 10px;
      line-height: 1.1;
      max-width: 460px;
  }
  
  .story-meta p {
      font-size: 1.5rem;
      color: rgba(255,255,255,0.7);
  }
  
  .story-wave-container {
      margin-top: 40px;
      opacity: 0.6;
  }

  .story-footer {
      position: relative;
      z-index: 2;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
  }
  
  .story-listen-tag {
      background: white;
      color: black;
      padding: 12px 24px;
      border-radius: 100px;
      font-weight: 700;
      font-size: 1.2rem;
  }
  
  .story-qr {
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 12px;
      padding: 5px;
  }

  /* Immersive Top Controls */
  .immersive-controls-top {
      position: absolute;
      top: 40px;
      right: 40px;
      display: flex;
      gap: 15px;
      z-index: 10;
  }

  .icon-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
  }
  
  .icon-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.05);
  }

  /* MODAL STYLES */
  .story-modal {
      position: fixed;
      inset: 0;
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
  }
  
  .story-modal.hidden {
      display: none;
  }
  
  .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
  }
  
  .modal-content-wrapper {
      position: relative;
      z-index: 2;
      display: flex;
      gap: 40px;
      align-items: center;
      height: 90vh;
  }
  
  .modal-preview-column {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
  }
  
  /* Scale preview to fit screen but keep aspect ratio 9:16 approx or just fixed */
  .scale-preview {
      transform: scale(0.65); /* Scale down for desktop view */
      transform-origin: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      border-radius: 20px; 
      /* Important: border radius on container so image doesn't bleed during rounded corners preview */
  }
  
  .modal-controls-column {
      width: 300px;
      background: #111;
      padding: 30px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
  }
  
  .modal-controls-column h3 {
      font-size: 1.5rem;
      margin-bottom: 10px;
  }
  
  .modal-controls-column p {
      color: #aaa;
      margin-bottom: 30px;
      font-size: 0.9rem;
  }
  
  .control-group {
      margin-bottom: 30px;
  }
  
  .control-group label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
  }
  
  .color-options {
      display: flex;
      gap: 10px;
  }
  
  .color-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: transform 0.2s;
  }
  
  .color-btn.active {
      border-color: white;
      transform: scale(1.1);
  }
  
  .modal-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
  }
  
  .btn-download {
      background: white;
      color: black;
      border: none;
      padding: 12px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      font-size: 1rem;
      transition: opacity 0.2s;
  }
  
  .btn-download:hover {
      opacity: 0.9;
  }
  
  .btn-cancel {
      background: transparent;
      color: #aaa;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
  }
  
  .btn-cancel:hover {
      color: white;
      border-color: white;
  }


