---
import ThemeToggle from './ThemeToggle.astro';
import CommandPalette from './CommandPalette.astro';
import AuthButton from './AuthButton.astro';

const navItems = [

  { 
    label: 'Contenido', 
    icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
    dropdown: [
      { label: 'Episodios', href: '/ep', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>' },
      { label: 'Blog', href: '/blog', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>' },
      { label: 'Clips', href: '/clips', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="7" x2="7" y1="3" y2="21"/><line x1="17" x2="17" y1="3" y2="21"/><line x1="3" x2="21" y1="12" y2="12"/><line x1="3" x2="7" y1="7" y2="7"/><line x1="3" x2="7" y1="17" y2="17"/><line x1="17" x2="21" y1="17" y2="17"/><line x1="17" x2="21" y1="7" y2="7"/></svg>' },
      { label: 'Galería', href: '/galeria', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>' }
    ]
  },
  { 
    label: 'Comunidad', 
    icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><circle cx="16" cy="7" r="4"/></svg>',
    dropdown: [
      { label: 'Equipo', href: '/equipo', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>' },
      { label: 'Invitados', href: '/invitados', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><circle cx="16" cy="7" r="4"/></svg>' },
      { label: 'Calendario', href: '/calendario', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="10" x2="21" y2="10"/></svg>' },
      { label: 'Participar', href: '/solicitar-entrevista', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>' },
      { label: 'FAQ / Ayuda', href: '/faq', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>' }
    ]
  },
  { 
    label: 'Contacto', 
    href: '/contacto', 
    icon: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>' 
  },
];

import { getCollection } from 'astro:content';

const premieres = (await getCollection('episodios'))
  .filter(e => e.data.isPremiere)
  .map(e => ({
    title: e.data.title,
    date: e.data.pubDate.getTime(),
    duration: e.data.duration || '0min', 
    slug: e.slug
  }));
  
const currentPath = Astro.url.pathname;

const isActive = (href: string) => {
    if (href === '/') return currentPath === '/';
    return currentPath.startsWith(href);
};

const isDropdownActive = (items: any[]) => {
  return items?.some(item => isActive(item.href));
};
---

<header class="header-wrapper">
  <!-- Dynamic Premiere Banner -->
  <a id="premiere-banner" class="premiere-banner hidden" href="#">
      <span class="banner-status">
        <span class="live-dot"></span>
        <span id="banner-label">EN DIRECTO</span>
      </span>
      <span id="banner-title" class="banner-title">Título del Episodio</span>
      <span class="banner-cta">Unirse →</span>
  </a>

  <div class="header-inner">
    <!-- Left Pill: Logo -->
    <a href="/" class="pill logo-pill">
      <div class="logo-icon-wrapper">
        <img src="/logo.png" alt="Veredillas FM" class="logo-image" />
      </div>
      <span class="logo-text">Veredillas<span class="highlight">FM</span></span>
    </a>

    <!-- Right Pill: Navigation & Actions -->
    <nav class="pill nav-pill">
      <ul class="nav-list">
        {navItems.map((item) => (
          <li class="nav-item">
            {item.dropdown ? (
              <div class={`nav-dropdown ${isDropdownActive(item.dropdown) ? 'active' : ''}`}>
                <button class="nav-link dropdown-trigger">
                  <span class="nav-icon" set:html={item.icon}></span>
                  <span class="nav-text">{item.label}</span>
                  <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </button>
                <div class="dropdown-menu">
                  {item.dropdown.map((subItem) => (
                    <a href={subItem.href} class={`dropdown-item ${isActive(subItem.href) ? 'active' : ''}`}>
                      <span class="dropdown-icon" set:html={subItem.icon}></span>
                      <span>{subItem.label}</span>
                    </a>
                  ))}
                </div>
              </div>
            ) : (
              <a href={item.href} class={`nav-link ${isActive(item.href) ? 'active' : ''}`}>
                <span class="nav-icon" set:html={item.icon}></span>
                <span class="nav-text">{item.label}</span>
              </a>
            )}
          </li>
        ))}
      </ul>
      
      <div class="divider"></div>

      <div class="actions">
        <!-- Utility / User Group -->
        <div class="utility-group">
            <CommandPalette />
            <AuthButton />
            <ThemeToggle />
        </div>

        <!-- Platforms Group -->
        <div class="platforms-group">
            <a href="https://open.spotify.com/show/6mXWyLhzhET5EHk1p72j18" target="_blank" class="action-btn spotify-btn" aria-label="Escúchanos en Spotify">
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.6 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
              </svg>
              <span class="spotify-tooltip">Escúchanos en Spotify</span>
            </a>
            <a href="https://music.amazon.es/podcasts/8d708ffa-7ef7-42f0-878d-fe3575491bef/veredillas-fm" target="_blank" class="action-btn amazon-btn" aria-label="Escúchanos en Amazon Music">
              <div class="icon-mask amazon-icon"></div>
              <span class="spotify-tooltip">Escúchanos en Amazon Music</span>
            </a>
            <a href="https://podcasts.apple.com/es/podcast/veredillas-fm/id1870103081" target="_blank" class="action-btn apple-btn" aria-label="Escúchanos en Apple Podcasts">
              <div class="icon-mask apple-icon"></div>
              <span class="spotify-tooltip">Escúchanos en Apple Podcasts</span>
            </a>
        </div>
      </div>
    </nav>
  
  <!-- Mobile Menu Toggle -->
  <button id="menu-toggle" class="menu-toggle pill" aria-label="Abrir menú">
    <div class="hamburger-box">
      <span class="hamburger-inner"></span>
    </div>
  </button>
  </div>
  </header>
  
  <style>
  .header-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    width: auto;
    z-index: 100;
    padding: var(--spacing-md);
    pointer-events: none; /* Let clicks pass through empty space */
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
  }
  
  /* PREMIERE BANNER */
  .premiere-banner {
      background: rgba(10, 10, 11, 0.8);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(220, 38, 38, 0.4);
      padding: 0.5rem 1.25rem;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      gap: 12px;
      pointer-events: auto;
      text-decoration: none;
      box-shadow: 0 4px 20px rgba(220, 38, 38, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transform-origin: top center;
      margin-bottom: 5px;
      max-width: 90%;
  }
  
  .premiere-banner:hover {
      background: rgba(10, 10, 11, 0.95);
      border-color: rgba(220, 38, 38, 0.8);
      transform: translateY(2px) scale(1.02);
      box-shadow: 0 8px 30px rgba(220, 38, 38, 0.3);
  }
  
  .premiere-banner.coming-soon {
       border-color: rgba(59, 130, 246, 0.4); /* Blue */
       box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
  }
  
  .premiere-banner.coming-soon:hover {
      border-color: rgba(59, 130, 246, 0.8);
      box-shadow: 0 8px 30px rgba(59, 130, 246, 0.3);
  }
  
  .banner-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 700;
      font-size: 0.8rem;
      color: #ef4444; /* Red */
      letter-spacing: 0.05em;
  }
  
  .coming-soon .banner-status {
      color: #3b82f6; /* Blue */
  }
  
  .coming-soon .live-dot {
      background: #3b82f6;
      box-shadow: 0 0 0 rgba(59, 130, 246, 0.4);
      animation: none;
  }
  
  .live-dot {
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      display: block;
      box-shadow: 0 0 0 rgba(239, 68, 68, 0.4);
      animation: pulse-red 2s infinite;
  }
  
  @keyframes pulse-red {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
  }
  
  .banner-title {
      color: var(--color-text-main);
      font-weight: 600;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 300px;
  }
  
  .banner-cta {
      color: var(--color-text-muted);
      font-size: 0.8rem;
      font-weight: 500;
      margin-left: auto;
  }
  
  .premiere-banner.hidden {
      display: none !important;
  }
  
  .header-inner {
    width: 100%; /* Ensure full width inside wrapper */
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .pill {
    background: rgba(10, 10, 11, 0.6); /* Glassy dark */
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 9999px;
    padding: 0.5rem 1.5rem;
    pointer-events: auto; /* Re-enable clicks */
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
  }
  
  :global([data-theme="light"]) .pill {
      background: rgba(255, 255, 255, 0.7);
      border-color: rgba(0, 0, 0, 0.05);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
  }
  
  /* Logo Pill */
  .logo-pill {
    padding-left: 0.5rem;
    padding-right: 1.5rem;
    gap: 0.75rem;
  }
  
  .logo-pill:hover, .nav-pill:hover {
      border-color: rgba(255, 255, 255, 0.15);
      background: rgba(10, 10, 11, 0.8);
      transform: translateY(-1px);
  }
  
  :global([data-theme="light"]) .logo-pill:hover, 
  :global([data-theme="light"]) .nav-pill:hover {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(0, 0, 0, 0.08); /* Darker border on hover light */
  }
  
  .logo-icon-wrapper {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      overflow: hidden;
  }
  
  .logo-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
  }
  
  .logo-text {
    font-family: var(--font-display);
    font-weight: 700;
    font-size: 1.125rem;
    letter-spacing: -0.02em;
    color: var(--color-text-main);
  }
  
  .highlight {
    color: var(--color-primary);
  }
  
  /* Nav Pill (Desktop) */
  .nav-pill {
      padding: 0.4rem 1rem;
      gap: 1.5rem;
  }
  
  .nav-list {
    display: flex;
    list-style: none;
    gap: 0.5rem;
    margin: 0;
    padding: 0;
  }
  
  .nav-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-text-muted);
    font-weight: 500;
    font-size: 0.93rem;
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    transition: all 0.2s ease;
  }
  
  .nav-link:hover {
      color: var(--color-text-main);
      background: rgba(255, 255, 255, 0.05);
  }
  
  :global([data-theme="light"]) .nav-link:hover {
      background: rgba(0, 0, 0, 0.05);
  }
  
  /* Active State - New Visual style */
  .nav-link.active {
      color: #3b82f6; /* Blue-500 equivalent */
      background: rgba(255, 255, 255, 0.1);
      font-weight: 600;
  }
  
  :global([data-theme="light"]) .nav-link.active {
      color: var(--color-primary);
      background: rgba(0, 0, 0, 0.05);
  }
  
  .nav-icon {
      font-size: 1rem;
      display: flex;
  }
  
  /* Dropdown Styles */
  .nav-item {
    position: relative;
  }

  .nav-dropdown {
    position: relative;
  }

  .dropdown-trigger {
    background: none;
    border: none;
    cursor: pointer;
    font-family: inherit;
  }

  .dropdown-arrow {
    transition: transform 0.3s ease;
    margin-left: 0.25rem;
  }

  .nav-dropdown:hover .dropdown-arrow {
    transform: rotate(180deg);
  }

  .dropdown-menu {
    position: absolute;
    top: calc(100% + 0.5rem);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(10, 10, 11, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 0.5rem;
    min-width: 200px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    opacity: 0;
    visibility: hidden;
    /* remove pointer-events: none; let visibility handle it */
    transition: 
      opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1),
      transform 0.2s cubic-bezier(0.4, 0, 0.2, 1),
      visibility 0s linear 0.2s; /* Hide visibility AFTER opacity fades */
    transition-delay: 0.3s; /* Wait before starting ANY transition */
    z-index: 1000;
  }

  /* Invisible bridge to prevent dropdown from closing */
  .dropdown-menu::before {
    content: '';
    position: absolute;
    top: -1.5rem;
    left: -20px;
    right: -20px;
    height: 1.5rem;
    background: transparent;
  }

  :global([data-theme="light"]) .dropdown-menu {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(0, 0, 0, 0.08);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  }

  .nav-dropdown:hover .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
    transition-delay: 0s;
    transition: 
      opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1),
      transform 0.2s cubic-bezier(0.4, 0, 0.2, 1),
      visibility 0s linear 0s; /* Instant visibility on show */
  }

  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 1rem;
    border-radius: 12px;
    color: var(--color-text-muted);
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  .dropdown-item:hover {
    background: rgba(255, 255, 255, 0.08);
    color: var(--color-text-main);
  }

  :global([data-theme="light"]) .dropdown-item:hover {
    background: rgba(0, 0, 0, 0.05);
  }

  .dropdown-item.active {
    color: var(--color-primary);
    background: rgba(139, 92, 246, 0.15);
  }

  .dropdown-icon {
    display: flex;
    opacity: 0.7;
  }

  .dropdown-item.active .dropdown-icon {
    opacity: 1;
  }

  /* Make Header More Compact */
  .header-wrapper {
    padding: 0.75rem var(--spacing-md);
  }

  .pill {
    padding: 0.375rem 1.25rem;
  }

  .logo-pill {
    padding-left: 0.375rem;
    padding-right: 1.25rem;
    gap: 0.625rem;
  }

  .logo-icon-wrapper {
    width: 36px;
    height: 36px;
  }

  .logo-text {
    font-size: 1rem;
  }

  .nav-pill {
    padding: 0.3rem 0.875rem;
    gap: 1.25rem;
  }

  .nav-link {
    padding: 0.4rem 0.875rem;
    font-size: 0.875rem;
  }
  
  /* Divider */
  .divider {
      width: 1px;
      height: 24px;
      background: rgba(255, 255, 255, 0.1);
  }
  
  :global([data-theme="light"]) .divider {
      background: rgba(0, 0, 0, 0.1);
  }
  
  /* Actions */
  .actions {
      display: flex;
      align-items: center;
      gap: 1.5rem; /* Increased gap between groups */
  }

  .utility-group, .platforms-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
  }

  
  .action-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      color: var(--color-text-muted);
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
  }
  
  :global([data-theme="light"]) .action-btn {
      background: #cbd5e1; /* Light grey background */
      border: 2px solid #475569; /* Dark grey border */
      color: #475569;
  }
  
  .action-btn:hover {
      color: var(--color-text-main);
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
  
  :global([data-theme="light"]) .action-btn:hover {
      background: #f1f5f9;
      border-color: #334155;
      color: #1e293b;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  /* Spotify Button Enhanced */
  .spotify-btn {
      color: #1DB954; /* Spotify Green */
      position: relative;
  }
  
  .spotify-btn:hover {
      color: #1ed760;
      background: #ffffff;
      border-color: #1DB954;
      box-shadow: 0 4px 15px rgba(29, 185, 84, 0.25);
      transform: translateY(-2px) scale(1.05);
  }
  
  .spotify-btn::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 50%;
      background: linear-gradient(135deg, #1DB954, #1ed760);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: -1;
      filter: blur(8px);
  }
  
  .spotify-btn:hover::before {
      opacity: 0.4;
      animation: pulse 2s ease-in-out infinite;
  }
  
  @keyframes pulse {
      0%, 100% {
          transform: scale(1);
          opacity: 0.4;
      }
      50% {
          transform: scale(1.1);
          opacity: 0.6;
      }
  }
  
  /* Tooltip */
  .spotify-tooltip {
      position: absolute;
      bottom: -45px;
      left: 50%;
      transform: translateX(-50%) translateY(5px);
      background: rgba(29, 185, 84, 0.95);
      color: white;
      padding: 0.5rem 0.75rem;
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 1000;
  }
  
  .spotify-tooltip::before {
      content: '';
      position: absolute;
      top: -4px;
      left: 50%;
      transform: translateX(-50%) rotate(45deg);
      width: 8px;
      height: 8px;
      background: rgba(29, 185, 84, 0.95);
  }
  
  .spotify-btn:hover .spotify-tooltip {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
  }
  
  /* Amazon Button Enhanced */
  .amazon-btn {
      color: #3cd0d9; /* Amazon Cyan */
      position: relative;
  }
  
  .amazon-btn:hover {
      color: #6aeff6;
      background: #ffffff;
      border-color: #3cd0d9;
      box-shadow: 0 4px 15px rgba(60, 208, 217, 0.25);
      transform: translateY(-2px) scale(1.05);
  }
  
  .amazon-btn::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3cd0d9, #6aeff6);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: -1;
      filter: blur(8px);
  }
  
  .amazon-btn:hover::before {
      opacity: 0.4;
      animation: pulse 2s ease-in-out infinite;
  }
  
  /* Shared Tooltip styles handle the rest, but let's ensure tooltip background matches if specific needed */
  .amazon-btn .spotify-tooltip {
      background: rgba(60, 208, 217, 0.95);
      color: black;
  }
  
  .amazon-btn .spotify-tooltip::before {
      background: rgba(60, 208, 217, 0.95);
  }
  
  .amazon-btn:hover .spotify-tooltip {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
  }
  
  :global([data-theme="light"]) .amazon-btn .spotify-tooltip {
      background: #3cd0d9;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  :global([data-theme="light"]) .amazon-btn .spotify-tooltip::before {
      background: #3cd0d9;
  }

  :global([data-theme="light"]) .spotify-tooltip {
      background: #1DB954;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  :global([data-theme="light"]) .spotify-tooltip::before {
      background: #1DB954;
  }
  
  /* Apple Podcasts Button Enhanced */
  .apple-btn {
      color: #A335EE; /* Apple Purple */
      position: relative;
  }
  
  .apple-btn:hover {
      color: #B55AF2;
      background: #ffffff;
      border-color: #A335EE;
      box-shadow: 0 4px 15px rgba(163, 53, 238, 0.25);
      transform: translateY(-2px) scale(1.05);
  }
  
  .apple-btn::before {
      content: '';
      position: absolute;
      inset: -2px;
      border-radius: 50%;
      background: linear-gradient(135deg, #A335EE, #B55AF2);
      opacity: 0;
      transition: opacity 0.3s;
      z-index: -1;
      filter: blur(8px);
  }
  
  .apple-btn:hover::before {
      opacity: 0.4;
      animation: pulse 2s ease-in-out infinite;
  }
  
  /* Reuse tooltips */
  .apple-btn .spotify-tooltip {
      background: rgba(163, 53, 238, 0.95);
  }
  
  .apple-btn .spotify-tooltip::before {
      background: rgba(163, 53, 238, 0.95);
  }
  
  .apple-btn:hover .spotify-tooltip {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
  }
  
  :global([data-theme="light"]) .apple-btn .spotify-tooltip {
      background: #A335EE;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  :global([data-theme="light"]) .apple-btn .spotify-tooltip::before {
      background: #A335EE;
  }

  /* SVG Mask Icons */
  .icon-mask {
      width: 22px;
      height: 22px;
      background-color: currentColor;
      mask-size: contain;
      mask-repeat: no-repeat;
      mask-position: center;
      -webkit-mask-size: contain;
      -webkit-mask-repeat: no-repeat;
      -webkit-mask-position: center;
  }

  .amazon-icon {
      mask-image: url('/svg/amazon-music.svg');
      -webkit-mask-image: url('/svg/amazon-music.svg');
  }

  .apple-icon {
      mask-image: url('/svg/apple-podcasts.svg');
      -webkit-mask-image: url('/svg/apple-podcasts.svg');
  }


  /* ========================================= */
  /* MOBILE REDESIGN (Hamburger)               */
  /* ========================================= */

  .menu-toggle {
      display: none;
      padding: 0;
      width: 40px;
      height: 40px;
      cursor: pointer;
      z-index: 200;
      justify-content: center;
      align-items: center;
      border: 1px solid rgba(255, 255, 255, 0.08);
  }

  .hamburger-box {
      width: 18px;
      height: 14px;
      position: relative;
  }

  .hamburger-inner {
      display: block;
      top: 50%;
      margin-top: -1px;
      width: 100%;
      height: 2px;
      background-color: var(--color-text-main);
      border-radius: 2px;
      position: absolute;
      transition: transform 0.15s ease;
  }

  .hamburger-inner::before,
  .hamburger-inner::after {
      content: "";
      display: block;
      width: 100%;
      height: 2px;
      background-color: var(--color-text-main);
      border-radius: 2px;
      position: absolute;
      transition: transform 0.15s ease;
  }

  .hamburger-inner::before { top: -6px; }
  .hamburger-inner::after { bottom: -6px; }

  /* Active State (X shape) */
  .menu-toggle.active .hamburger-inner {
      transform: rotate(45deg);
  }
  .menu-toggle.active .hamburger-inner::before {
      top: 0;
      opacity: 0;
  }
  .menu-toggle.active .hamburger-inner::after {
      bottom: 0;
      transform: rotate(-90deg);
  }

  @media (max-width: 1024px) {
      .header-wrapper {
          padding: 0.75rem 1rem;
      }
      
      .menu-toggle {
          display: flex;
          color: var(--color-text-main);
      }
      
      :global([data-theme="light"]) .menu-toggle {
          background: rgba(255, 255, 255, 0.7);
          border-color: rgba(0, 0, 0, 0.05);
      }

      /* Logo Pill */
      .logo-pill {
          padding-left: 0.25rem;
          padding-right: 1rem;
          background: rgba(10, 10, 11, 0.7);
          backdrop-filter: blur(12px);
      }

      /* NAV PILL - The Full Screen Overlay */
      .nav-pill {
          position: fixed !important;
          top: 0;
          left: 0;
          width: 100vw !important;
          height: 100vh !important; /* Fallback */
          height: 100dvh !important;
          margin: 0 !important;
          max-width: none !important;
          
          background: var(--color-bg); /* Opaque background */
          display: flex;
          flex-direction: column;
          /* Changed from center to flex-start to allow scrolling */
          justify-content: flex-start; 
          align-items: center;
          z-index: 150;
          border-radius: 0 !important;
          border: none !important;
          padding: 2rem;
          /* Add top padding to avoid hitting the logo/close button */
          padding-top: 6rem;
          padding-bottom: 4rem;
          box-sizing: border-box;
          
          /* Enable Scrolling */
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
          
          /* Animation Start State */
          opacity: 0;
          visibility: hidden;
          transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
          pointer-events: none;
          
          /* Slide from bottom subtle */
          transform: translateY(20px) scale(0.98);
      }
      
      :global([data-theme="light"]) .nav-pill {
          background: #ffffff;
      }

      .nav-pill.menu-open {
          opacity: 1;
          visibility: visible;
          transform: translateY(0) scale(1);
          pointer-events: auto;
      }

      /* Navigation List Items */
      .nav-list {
          flex-direction: column;
          align-items: center;
          gap: 1.5rem; /* Reduced gap from 2rem */
          width: 100%;
          flex-shrink: 0; /* Prevent shrinking */
      }

      .nav-link {
          font-size: 1.75rem; /* Slightly smaller to save space */
          font-weight: 700;
          padding: 0;
          width: auto;
          justify-content: center;
          flex-direction: row;
          background: transparent !important;
          
          /* Stagger Animation Setup */
          opacity: 0;
          transform: translateY(20px);
          transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      
      .menu-open .nav-link {
          opacity: 1;
          transform: translateY(0);
      }
      
      /* Stagger Delays */
      .menu-open li:nth-child(1) .nav-link { transition-delay: 0.1s; }
      .menu-open li:nth-child(2) .nav-link { transition-delay: 0.15s; }
      .menu-open li:nth-child(3) .nav-link { transition-delay: 0.2s; }
      .menu-open li:nth-child(4) .nav-link { transition-delay: 0.25s; }
      .menu-open li:nth-child(5) .nav-link { transition-delay: 0.3s; }

      .nav-text {
          display: inline-block;
      }
      
      .nav-icon {
          display: none; /* Hide icons for cleaner big text look, or keep if preferred */
      }
      .nav-icon svg {
          width: 32px;
          height: 32px;
      }

      /* Actions in Menu */
      .actions {
          flex-direction: column;
          width: 100%;
          gap: 2rem;
          margin-top: 2rem;
          /* Remove scale to fix layout issues with buttons */
          scale: 1; 
          flex-shrink: 0; /* Prevent shrinking */
          
          opacity: 0;
          transform: translateY(20px);
          transition: all 0.4s ease 0.4s; /* Delay after links */
      }

      .utility-group {
        flex-direction: column;
        width: 100%;
        gap: 1.5rem; /* Spacing between auth/theme/command */
      }

      .platforms-group {
        justify-content: center;
        gap: 2rem;
        transform: scale(1.3); /* Make platform icons larger */
      }

      /* Force centered content in utility group */
      .utility-group :global(.cmd-btn) {
          width: 100%;
          justify-content: center;
          padding: 1rem;
          font-size: 1.1rem;
      }

      .utility-group :global(#auth-button-wrapper),
      .utility-group :global(.profile-dropdown-container) {
          width: 100%;
          justify-content: center;
      }
      
      .utility-group :global(.auth-btn), 
      .utility-group :global(.profile-btn) {
          width: 100% !important;
          justify-content: center !important;
          padding: 1rem !important;
          font-size: 1.1rem !important;
      }
      
      .menu-open .actions {
          opacity: 1;
          transform: translateY(0);
      }

      .divider {
          display: none;
      }
      
      .nav-link.active {
          color: var(--color-primary);
      }
  }
</style>

<script>
  // Update active state on navigation (Client-side)
  document.addEventListener('DOMContentLoaded', () => {
    // 1. Highlight Active Link
    const currentPath = window.location.pathname;
    const navLinks = document.querySelectorAll('.nav-link');
    
    navLinks.forEach(link => {
      const href = link.getAttribute('href');
      if (href === '/') {
        if (currentPath === '/') link.classList.add('active');
        else link.classList.remove('active');
      } else {
         if (href && currentPath.startsWith(href)) {
             link.classList.add('active');
         } else {
             link.classList.remove('active');
         }
      }
    });

    // 2. Mobile Menu Logic
    const menuToggle = document.getElementById('menu-toggle');
    const navPill = document.querySelector('.nav-pill');
    
    if (menuToggle && navPill) {
        menuToggle.addEventListener('click', () => {
            const isOpen = navPill.classList.toggle('menu-open');
            menuToggle.classList.toggle('active');
            
            // Prevent body scroll when menu is open
            if (isOpen) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        });

        // Close menu when clicking a link
        const links = navPill.querySelectorAll('a');
        links.forEach(link => {
            link.addEventListener('click', () => {
                navPill.classList.remove('menu-open');
                menuToggle.classList.remove('active');
                document.body.style.overflow = '';
            });
        });
    }
  });
</script>

<script define:vars={{ premieres }}>
  // Logic to handle Premiere Banner
  // Runs immediately
  
  // Logic to handle Premiere Banner and Live Stream
  // Runs immediately
  
  const STREAM_URL = 'https://live.veredillasfm.es/stream-pro.m3u8';
  let isStreamOnline = false;

  function parseDuration(durStr) {
      if(!durStr) return 0;
      let totalMs = 0;
      const hours = durStr.match(/(\d+)\s*h/);
      const mins = durStr.match(/(\d+)\s*min/);
      if(hours) totalMs += parseInt(hours[1]) * 60 * 60 * 1000;
      if(mins) totalMs += parseInt(mins[1]) * 60 * 1000;
      return totalMs || (10 * 60 * 1000);
  }

  function updateBanner() {
      const banner = document.getElementById('premiere-banner');
      if(!banner) return;
      
      const labelEl = document.getElementById('banner-label');
      const titleEl = document.getElementById('banner-title');

      // 1. Live Stream Support (Priority #1)
      if (isStreamOnline) {
          banner.classList.remove('hidden');
          banner.classList.remove('coming-soon'); // Ensure it's live style (red)
          banner.href = "/live";
          if(labelEl) labelEl.textContent = "EN DIRECTO";
          if(titleEl) titleEl.textContent = "Emisión en Directo desde el Estudio"; 
          return; // Stop here, live stream takes precedence
      }

      // 2. Scheduled Premieres (Priority #2)
      const now = Date.now();
      const SOON_THRESHOLD = 2 * 60 * 60 * 1000; // 2 Hours
      
      let activePremiere = null;
      let soonPremiere = null;
      
      premieres.forEach(p => {
          const duration = parseDuration(p.duration);
          const endTime = p.date + duration;
          
          if (now >= p.date && now < endTime) {
              activePremiere = p;
          }
          
          if (p.date > now && (p.date - now) <= SOON_THRESHOLD) {
              if (!soonPremiere || p.date < soonPremiere.date) {
                  soonPremiere = p;
              }
          }
      });
      
      const target = activePremiere || soonPremiere;
      
      if (target) {
          banner.classList.remove('hidden');
          banner.href = `/ep/${target.slug}`;
          
          if(titleEl) titleEl.textContent = target.title;
          
          if (activePremiere) {
              banner.classList.remove('coming-soon');
              if(labelEl) labelEl.textContent = "EN DIRECTO";
          } else {
              banner.classList.add('coming-soon');
              const minsLeft = Math.ceil((target.date - now) / 60000);
              let timeText = "";
              if(minsLeft >= 60) {
                 const h = Math.floor(minsLeft/60);
                 const m = minsLeft % 60;
                 timeText = `${h}h ${m}m`;
              } else {
                 timeText = `${minsLeft}m`;
              }
              if(labelEl) labelEl.textContent = `ESTRENO EN ${timeText}`;
          }
      } else {
          banner.classList.add('hidden');
      }
  }
  
  function checkStreamStatus() {
       fetch(STREAM_URL, { method: 'HEAD' })
       .then(res => {
           const wasOnline = isStreamOnline;
           isStreamOnline = res.ok;
           if(wasOnline !== isStreamOnline) updateBanner();
       })
       .catch(() => {
           isStreamOnline = false;
           updateBanner();
       });
  }
  
  // Init
  checkStreamStatus();
  updateBanner(); // Run once immediately too (for premieres)
  
  // Poll
  setInterval(checkStreamStatus, 15000); // Check stream every 15s
  setInterval(updateBanner, 60000); // Check premieres every 1m
</script>
