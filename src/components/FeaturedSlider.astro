---
import { getCollection } from 'astro:content';
import 'swiper/css';
import 'swiper/css/effect-fade';

const allEpisodes = await getCollection('episodios');
// Get latest 5 episodes for the featured slider
const featuredEpisodes = allEpisodes
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 5);
---

<div class="featured-widget">
    <div class="swiper featured-swiper">
        <div class="swiper-wrapper">
            {featuredEpisodes.map((post) => (
                <div class="swiper-slide">
                    <div class="slide-content">
                        {post.data.image ? (
                            <img src={post.data.image} alt={post.data.title} class="slide-image" />
                        ) : (
                            <div class="image-placeholder"></div>
                        )}
                        <div class="glass-overlay">
                            <h3 class="slide-title">{post.data.title}</h3>
                            <p class="slide-desc">{post.data.description ? post.data.description.slice(0, 100) + '...' : ''}</p>
                            <div class="custom-pagination"></div>
                        </div>
                        <a href={`/ep/${post.slug}`} class="full-link"><span class="sr-only"></span></a>
                    </div>
                </div>
            ))}
        </div>
        
        <!-- Navigation Arrows -->
        <button class="nav-btn prev-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
        </button>
        <button class="nav-btn next-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </button>
    </div>
</div>

<script>
    import Swiper from 'swiper';
    import { Navigation, Pagination, EffectFade, Autoplay } from 'swiper/modules';

    const initSwiper = () => {
        const swiperEl = document.querySelector('.featured-swiper');
        if (!swiperEl) return;

        new Swiper('.featured-swiper', {
            modules: [Navigation, Pagination, EffectFade, Autoplay],
            observer: true,
            observeParents: true,
            effect: 'fade',
            fadeEffect: {
                crossFade: true
            },
            loop: true,
            autoplay: {
                delay: 6000,
                disableOnInteraction: false,
            },
            speed: 800,
            navigation: {
                nextEl: '.next-btn',
                prevEl: '.prev-btn',
            },
            pagination: {
                el: '.custom-pagination',
                clickable: true,
                renderBullet: function (index, className) {
                    return '<span class="' + className + '"></span>';
                },
            },
        });
    };

    // Run on initial load and after every navigation
    document.addEventListener('astro:page-load', initSwiper);
</script>

<style>
    .featured-widget {
        width: 100%;
        max-width: 1000px;
        margin: 0 auto;
        border-radius: 24px;
        overflow: hidden;
        position: relative;
        box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
    }

    .featured-swiper {
        width: 100%;
        height: 500px; /* Adjust height as needed */
    }

    .swiper-slide {
        width: 100%;
        height: 100%;
    }

    .slide-content {
        position: relative;
        width: 100%;
        height: 100%;
    }

    .slide-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .image-placeholder {
        width: 100%;
        height: 100%;
        background: linear-gradient(45deg, #1a1a1a, #2a2a2a);
    }

    /* Glass Overlay */
    .glass-overlay {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        width: 85%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        padding: 2rem;
        border-radius: 20px;
        text-align: center;
        color: white;
        z-index: 10;
        border: 1px solid rgba(255,255,255,0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
    }

    .slide-title {
        font-family: var(--font-display);
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
        line-height: 1.2;
    }

    .slide-desc {
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.8);
        max-width: 600px;
        margin: 0 auto 1.5rem;
        line-height: 1.5;
    }

    /* Navigation Buttons */
    .nav-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        z-index: 20;
        background: transparent;
        border: none;
        color: white;
        cursor: pointer;
        padding: 1rem;
        opacity: 0.5;
        transition: opacity 0.3s ease;
    }
    
    .nav-btn:hover {
        opacity: 1;
    }

    .prev-btn { left: 1rem; }
    .next-btn { right: 1rem; }

    .nav-btn svg {
        width: 32px;
        height: 32px;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
    }

    /* Custom Pagination */
    :global(.custom-pagination) {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 5px;
    }

    :global(.swiper-pagination-bullet) {
        width: 30px;
        height: 4px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
        transition: all 0.3s ease;
        opacity: 1;
        cursor: pointer;
    }

    :global(.swiper-pagination-bullet-active) {
        background: white;
        width: 45px;
    }

    .full-link {
        position: absolute;
        inset: 0;
        z-index: 5;
    }

    @media (max-width: 768px) {
        .featured-swiper {
            height: 450px;
        }

        .glass-overlay {
            width: 90%;
            bottom: 20px;
            padding: 1.5rem;
        }

        .slide-title {
            font-size: 1.25rem;
        }

        .slide-desc {
            font-size: 0.85rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    }
</style>
