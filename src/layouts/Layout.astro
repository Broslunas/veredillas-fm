---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import MiniPlayer from '../components/MiniPlayer.astro';
import CookieConsent from '../components/CookieConsent.astro';
import { ClientRouter } from 'astro:transitions';
import ToastNotification from '../components/ToastNotification.astro';

interface Props {
	title: string;
	description?: string;
	image?: string;
	imageAlt?: string;
	type?: 'website' | 'article' | 'profile';
	publishedTime?: string;
	modifiedTime?: string;
	author?: string;
	tags?: string[];
	canonicalURL?: string;
	showFooter?: boolean;
}

const { 
	title, 
	description = "Veredillas FM es el podcast oficial del IES Veredillas. Descubre entrevistas exclusivas, noticias del instituto, cultura estudiantil y mucho m√°s. Una radio hecha por alumnos, para alumnos.",
	image = "/logo.png",
	imageAlt = "Veredillas FM - El podcast oficial del IES Veredillas",
	type = "website",
	publishedTime,
	modifiedTime,
	author = "Veredillas FM",
	tags = [],
	canonicalURL = new URL(Astro.url.pathname, Astro.site).href,
	showFooter = true
} = Astro.props;

// Asegurar que la imagen sea una URL completa
const ogImage = image.startsWith('http') ? image : new URL(image, Astro.site).href;
const siteUrl = Astro.site?.href || 'https://veredillasfm.es';
const fullTitle = title === "Inicio" ? "Veredillas FM - El Podcast del IES Veredillas" : `${title} | Veredillas FM`;
---

<!doctype html>
<html lang="es">
	<head>
		<!-- Google tag (gtag.js) -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-N33MZ5JH43"></script>
		<script is:inline>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());

			gtag('config', 'G-N33MZ5JH43');
		</script>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" type="image/x-icon" href="/favicon.ico" />
		<meta name="generator" content={Astro.generator} />
		
		<!-- Primary Meta Tags -->
		<title>{fullTitle}</title>
		<meta name="title" content={fullTitle} />
		<meta name="description" content={description} />
		<meta name="author" content={author} />
		{tags.length > 0 && <meta name="keywords" content={tags.join(', ')} />}
		<link rel="canonical" href={canonicalURL} />
		
		<!-- Open Graph / Facebook / WhatsApp / LinkedIn -->
		<meta property="og:type" content={type} />
		<meta property="og:url" content={canonicalURL} />
		<meta property="og:title" content={fullTitle} />
		<meta property="og:description" content={description} />
		<meta property="og:image" content={ogImage} />
		<meta property="og:image:alt" content={imageAlt} />
		<meta property="og:image:width" content="1200" />
		<meta property="og:image:height" content="630" />
		<meta property="og:site_name" content="Veredillas FM" />
		<meta property="og:locale" content="es_ES" />
		{publishedTime && <meta property="article:published_time" content={publishedTime} />}
		{modifiedTime && <meta property="article:modified_time" content={modifiedTime} />}
		{author && type === 'article' && <meta property="article:author" content={author} />}
		{tags.length > 0 && tags.map(tag => <meta property="article:tag" content={tag} />)}
		
		<!-- Twitter Card -->
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:url" content={canonicalURL} />
		<meta name="twitter:title" content={fullTitle} />
		<meta name="twitter:description" content={description} />
		<meta name="twitter:image" content={ogImage} />
		<meta name="twitter:image:alt" content={imageAlt} />
		<meta name="twitter:creator" content="@VeredillasFM" />
		<meta name="twitter:site" content="@VeredillasFM" />
		
		<!-- Additional SEO Meta Tags -->
		<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
		<meta name="googlebot" content="index, follow" />
		<meta name="language" content="Spanish" />
		<meta name="revisit-after" content="7 days" />
		<meta name="theme-color" content="#8b5cf6" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		<meta name="apple-mobile-web-app-title" content="Veredillas FM" />
		<meta name="format-detection" content="telephone=no" />
		
		<!-- PWA Manifest -->
		<link rel="manifest" href="/manifest.json" />
		
		<!-- RSS Feed -->
		<link rel="alternate" type="application/rss+xml" title="Veredillas FM RSS Feed" href="/rss.xml" />
		
		<!-- Humans.txt -->
		<link rel="author" type="text/plain" href="/humans.txt" />
		
		<!-- Schema.org JSON-LD -->
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": type === 'article' ? "Article" : "WebSite",
			"name": fullTitle,
			"description": description,
			"url": canonicalURL,
			"image": ogImage,
			"publisher": {
				"@type": "Organization",
				"name": "Veredillas FM",
				"logo": {
					"@type": "ImageObject",
					"url": new URL("/logo.png", Astro.site).href
				}
			},
			...(type === 'article' && publishedTime ? {
				"datePublished": publishedTime,
				"dateModified": modifiedTime || publishedTime,
				"author": {
					"@type": "Person",
					"name": author
				}
			} : {
				"potentialAction": {
					"@type": "SearchAction",
					"target": {
						"@type": "EntryPoint",
						"urlTemplate": `${siteUrl}/blog?q={search_term_string}`
					},
					"query-input": "required name=search_term_string"
				}
			})
		})} />
		
        
        <script>
            // Custom SPA Router to prevent Iframe Reloads
            // This replaces Astro's ClientRouter because moving an iframe in DOM (which standard ViewTransitions does) forces a reload.
            // By only swapping the <main> content, the footer/mini-player remain untouched in the DOM.

            const pageCache = new Map<string, string>();

            async function prefetch(url: string) {
                if (pageCache.has(url)) return;
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        const html = await response.text();
                        pageCache.set(url, html);
                    }
                } catch (e) {
                    console.log("Prefetch failed", e);
                }
            }

            async function navigate(url: string, push: boolean = true) {
                try {
                    // Fetch new page (check cache first)
                    let html: string;
                    if (pageCache.has(url)) {
                        html = pageCache.get(url)!;
                    } else {
                        const response = await fetch(url);
                        html = await response.text();
                        // Cache it for subsequent back/forward navs
                        pageCache.set(url, html);
                    }
                    
                    // Parse
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // Handle New Styles (CSS)
                    // We must inject new styles found in the fetched page to the current head
                    const newHead = doc.head;
                    const newStyles = newHead.querySelectorAll('style, link[rel="stylesheet"]');
                    
                    newStyles.forEach(newStyle => {
                        let exists = false;
                        if (newStyle.tagName === 'LINK') {
                             const href = newStyle.getAttribute('href');
                             if (href && document.head.querySelector(`link[rel="stylesheet"][href="${href}"]`)) {
                                 exists = true;
                             }
                        } else if (newStyle.tagName === 'STYLE') {
                             // Check text content to avoid duplicates
                             const currentStyles = document.head.querySelectorAll('style');
                             for (const style of currentStyles) {
                                  if (style.innerHTML === newStyle.innerHTML) {
                                      exists = true;
                                      break;
                                  }
                             }
                        }
                        
                        if (!exists) {
                            document.head.appendChild(newStyle.cloneNode(true));
                        }
                    });
                    
                    // Handle New Scripts (Head)
                    const newScripts = newHead.querySelectorAll('script');
                    newScripts.forEach(newScript => {
                        if (newScript.src) {
                            if (!document.head.querySelector(`script[src="${newScript.src}"]`)) {
                                const s = document.createElement('script');
                                Array.from(newScript.attributes).forEach(attr => s.setAttribute(attr.name, attr.value));
                                document.head.appendChild(s);
                            }
                        } else {
                            // Inline head scripts
                            // Check if this script content already exists to avoid duplicates
                            const currentScripts = document.head.querySelectorAll('script');
                            let isDuplicate = false;
                            for (const script of currentScripts) {
                                if (!script.src && script.innerHTML === newScript.innerHTML) {
                                    isDuplicate = true;
                                    break;
                                }
                            }
                            
                            if (!isDuplicate) {
                                const s = document.createElement('script');
                                Array.from(newScript.attributes).forEach(attr => s.setAttribute(attr.name, attr.value));
                                s.appendChild(document.createTextNode(newScript.innerHTML));
                                document.head.appendChild(s);
                            }
                        }
                    });
                    
                    // Swap Content
                    const oldMain = document.querySelector('main');
                    const newMain = doc.querySelector('main');
                    const newTitle = doc.querySelector('title');

                    if (oldMain && newMain) {
                        // Optional: Fade out effect
                         oldMain.style.opacity = '0';
                         oldMain.style.transition = 'opacity 0.2s';
                         
                         setTimeout(() => {
                             oldMain.innerHTML = newMain.innerHTML;
                             // Copy attributes/classes if main changed (e.g. layout shifts)
                             oldMain.className = newMain.className;
                             
                             // EXECUTE SCRIPTS IN MAIN
                             // innerHTML does not execute scripts. We must manually replace them.
                             oldMain.querySelectorAll('script').forEach(script => {
                                 const newScript = document.createElement('script');
                                 Array.from(script.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                                 newScript.appendChild(document.createTextNode(script.innerHTML));
                                 if (script.parentNode) script.parentNode.replaceChild(newScript, script);
                             });
                             
                             // Scroll to top
                             window.scrollTo(0, 0);
                             
                             oldMain.style.opacity = '1';

                             // Update Title
                             if (newTitle) document.title = newTitle.innerText;

                             // Update History
                             if (push) history.pushState({}, '', url);

                             // Fire Astro Event
                             // We wait a tick to ensure scripts have parsed/run
                             setTimeout(() => {
                                 document.dispatchEvent(new Event('astro:page-load'));
                             }, 50);
                         }, 200);
                    }

                } catch (e) {
                    console.error("Navigation failed", e);
                    window.location.href = url; // Fallback
                }
            }
            
            // Prefetch on hover
            document.addEventListener('mouseover', (e) => {
                const link = (e.target as Element).closest('a');
                if (link) {
                    const href = link.getAttribute('href');
                     if (href && href.startsWith('/') && !href.startsWith('#') && !link.hasAttribute('download') && link.target !== '_blank') {
                        prefetch(href);
                    }
                }
            });
            
            document.addEventListener('touchstart', (e) => {
                 const link = (e.target as Element).closest('a');
                 if (link) {
                     const href = link.getAttribute('href');
                      if (href && href.startsWith('/') && !href.startsWith('#') && !link.hasAttribute('download') && link.target !== '_blank') {
                         prefetch(href);
                     }
                 }
            }, { passive: true });

            // Intercept Clicks
            document.addEventListener('click', (e) => {
                const link = (e.target as Element).closest('a');
                if (link) {
                    const href = link.getAttribute('href');
                    if (href && href.startsWith('/') && !href.startsWith('#') && !link.hasAttribute('download') && link.target !== '_blank') {
                        e.preventDefault();
                        navigate(href);
                    }
                }
            });

            // Handle Back/Forward
            window.addEventListener('popstate', () => {
                navigate(window.location.pathname, false);
            });
            
            // Initial load event
            document.addEventListener('DOMContentLoaded', () => {
                 document.dispatchEvent(new Event('astro:page-load'));
            });
        </script>

        <script is:inline>
            // Initialize theme from LocalStorage or Cookies
            const getCookie = (name) => {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }
            
            const theme = localStorage.getItem('theme') || getCookie('theme');
            
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        </script>
	</head>

	<body>
		<Header />
		<main>
			<slot />
		</main>
		{showFooter && <Footer />}
        <MiniPlayer />
        <CookieConsent />
        <ToastNotification />
	</body>
</html>

<style>
	main {
		min-height: 100vh;
		padding-top: 100px; /* Increased space for floating header */
	}

    @media (max-width: 768px) {
        main {
            padding-top: 80px; /* Smaller header on mobile */
        }
    }
</style>


