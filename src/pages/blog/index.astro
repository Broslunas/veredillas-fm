---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const posts = await getCollection('blog');
const sortedPosts = posts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get unique tags
const allTags = ['Todos', ...new Set(posts.flatMap(post => post.data.tags || []))];
---

<Layout 
  title="Blog"
  description="Lee las últimas noticias, historias y acontecimientos del IES Veredillas. Descubre el día a día de nuestro instituto contado por los propios estudiantes."
  image="/logo.png"
  imageAlt="Blog Veredillas FM - Noticias y actualidad del IES Veredillas"
  tags={['blog', 'noticias escolares', 'IES Veredillas', 'actualidad estudiantil', 'vida escolar']}
>
    <div class="container page-header">
        <h1>Blog Veredillas</h1>
        <p class="subtitle">Noticias, historias y el día a día de nuestro instituto.</p>

        <!-- Filter System -->
        <div class="filter-container fade-in-up">
            {allTags.map(tag => (
                <button 
                    class={`filter-btn ${tag === 'Todos' ? 'active' : ''}`} 
                    data-filter={tag}
                >
                    {tag}
                </button>
            ))}
        </div>
    </div>

    <div class="container">
        <div class="blog-grid" id="blog-grid">
            {sortedPosts.map(post => (
                <article 
                    class="blog-card glass-panel post-item" 
                    data-tags={post.data.tags?.join(',') || ''}
                >
                    <a href={`/blog/${post.slug}`} class="card-link">
                        {post.data.image && (
                             <div class="card-image-wrapper">
                                <img src={post.data.image} alt={post.data.title} loading="lazy" />
                            </div>
                        )}
                        <div class="card-content">
                            <div class="meta">
                                <time>{post.data.pubDate.toLocaleDateString('es-ES', { dateStyle: 'long' })}</time>
                            </div>
                            <h2>{post.data.title}</h2>
                            <p>{post.data.description}</p>
                            <span class="read-more">Leer más &rarr;</span>
                        </div>
                    </a>
                </article>
            ))}
        </div>
        
        <div id="no-results" class="no-results hidden">
            <p>No se encontraron artículos en esta categoría.</p>
            <button id="reset-filter" class="btn btn-outline btn-sm">Ver todos</button>
        </div>
    </div>
</Layout>

<script>
    document.addEventListener('astro:page-load', () => {
        const filterBtns = document.querySelectorAll('.filter-btn');
        const items = document.querySelectorAll('.post-item');
        const noResults = document.getElementById('no-results');
        const resetBtn = document.getElementById('reset-filter');

        function filterItems(category: string) {
            let visibleCount = 0;

            // Update Active State
            filterBtns.forEach(btn => {
                if (btn.getAttribute('data-filter') === category) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            // Show/Hide Items
            items.forEach((item) => {
                const itemEl = item as HTMLElement;
                const tags = itemEl.getAttribute('data-tags')?.split(',') || [];
                
                if (category === 'Todos' || tags.includes(category)) {
                    itemEl.style.display = '';
                    visibleCount++;
                } else {
                    itemEl.style.display = 'none';
                }
            });

            // Empty State
            if (visibleCount === 0) {
                noResults?.classList.remove('hidden');
            } else {
                noResults?.classList.add('hidden');
            }
        }

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const category = btn.getAttribute('data-filter') || 'Todos';
                filterItems(category);
            });
        });
        
        resetBtn?.addEventListener('click', () => {
            filterItems('Todos');
        });
    });
</script>

<style>
    .page-header {
        padding: var(--spacing-2xl) var(--spacing-md);
        text-align: center;
    }

    h1 {
        font-size: 3rem;
        margin-bottom: var(--spacing-sm);
    }
    
    .subtitle {
        color: var(--color-text-muted);
        font-size: 1.25rem;
    }

    .blog-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: var(--spacing-lg);
        padding-bottom: var(--spacing-2xl);
    }

    .blog-card {
        border-radius: var(--radius-lg);
        overflow: hidden;
        transition: transform 0.3s ease;
    }

    .blog-card:hover {
        transform: translateY(-5px);
        border-color: var(--color-primary);
    }

    .card-link {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .card-image-wrapper {
        aspect-ratio: 16/9;
        overflow: hidden;
    }

    .card-image-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .blog-card:hover img {
        transform: scale(1.05);
    }

    .card-content {
        padding: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }

    .meta {
        font-size: 0.875rem;
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-sm);
    }

    h2 {
        font-size: 1.5rem;
        margin-bottom: var(--spacing-sm);
        line-height: 1.2;
    }

    p {
        color: var(--color-text-muted);
        margin-bottom: var(--spacing-lg);
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .read-more {
        margin-top: auto;
        color: var(--color-primary);
        font-weight: 600;
        font-size: 0.9rem;
    }

    /* Filter Styles */
    .filter-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.75rem;
        margin-top: 2rem;
    }

    .filter-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: var(--color-text-muted);
        padding: 0.5rem 1.25rem;
        border-radius: 100px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .filter-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--color-text-main);
        transform: translateY(-2px);
    }

    .filter-btn.active {
        background: var(--color-primary);
        color: white;
        border-color: var(--color-primary);
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    /* No Results */
    .no-results {
        text-align: center;
        padding: 4rem 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1.5rem;
    }

    .no-results p {
        color: var(--color-text-muted);
        font-size: 1.2rem;
    }

    .hidden {
        display: none !important;
    }
</style>
