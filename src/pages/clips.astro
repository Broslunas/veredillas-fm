---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

export const prerender = false;

const allEpisodes = await getCollection('episodios');

function getVideoId(url: string): string | null {
  const patterns = [
    /youtube\.com\/shorts\/([^?&]+)/,
    /(?:youtube\.com\/watch\?v=|youtube\.com\/watch\?.+&v=)([^&]+)/,
    /youtu\.be\/([^?&]+)/,
    /youtube\.com\/embed\/([^?&]+)/,
  ];
  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match) return match[1];
  }
  return null;
}

// Extract all clips and shuffle them for a "feed" feel
let clips = allEpisodes.flatMap(episode => {
  return (episode.data.clips || []).map(clip => ({
    ...clip,
    videoId: getVideoId(clip.url),
    episodeTitle: episode.data.title,
    episodeSlug: episode.slug,
    episodeImage: episode.data.image
  }));
}).sort(() => Math.random() - 0.5); // Simple shuffle

// Build a map of clips grouped by episode slug for the side panel
const clipsByEpisode: Record<string, {episodeTitle: string, episodeImage: string, clips: Array<{title: string, videoId: string | null, url: string}>}> = {};
allEpisodes.forEach(episode => {
  const epClips = (episode.data.clips || []).map(clip => ({
    title: clip.title,
    videoId: getVideoId(clip.url),
    url: clip.url
  }));
  if (epClips.length > 0) {
    clipsByEpisode[episode.slug] = {
      episodeTitle: episode.data.title,
      episodeImage: typeof episode.data.image === 'string' ? episode.data.image : (episode.data.image?.src || '/placeholder.jpg'),
      clips: epClips
    };
  }
});

// Check for watch param and move to start
const watchId = Astro.url.searchParams.get('watch');
if (watchId) {
    const index = clips.findIndex(c => c.videoId === watchId);
    if (index > -1) {
        const [selectedClip] = clips.splice(index, 1);
        clips.unshift(selectedClip);
    }
}
---

<Layout title="Clips" description="Los mejores momentos de Veredillas FM en formato corto." showFooter={false}>
  <div class="clips-container" id="clips-container">
    {clips.length > 0 ? (
      clips.map((clip, index) => {
        const videoId = clip.videoId;
        if (!videoId) return null;
        
        return (
        <div class="clip-section" id={`clip-section-${index}`}>
          <div class="video-wrapper">
             <div id={`player-${index}`} class="youtube-player" data-video-id={videoId}></div>
             <!-- Interaction layer for custom play/pause -->
             <div class="interaction-layer" data-target={`player-${index}`}></div>
          </div>
          
          <div class="clip-overlay">
            <div class="clip-info">
                <h2 class="clip-title">{clip.title}</h2>
                <a href={`/ep/${clip.episodeSlug}`} class="episode-link">
                    <span class="episode-icon">üéôÔ∏è</span>
                    <span class="episode-name">{clip.episodeTitle}</span>
                </a>
            </div>
            
            <div class="clip-actions">
                <button class="action-btn episode-clips-btn" aria-label="Ver clips del episodio" data-episode-slug={clip.episodeSlug} onclick="handleOpenEpisodeClips(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                </button>
                <button class="action-btn like-btn" aria-label="Me gusta" data-clip-id={videoId} onclick="handleLikeClip(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="heart-icon"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                </button>
                <button class="action-btn share-btn" aria-label="Compartir" data-clip-id={videoId} onclick="handleShareClip(this)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                </button>
                <a href={`/ep/${clip.episodeSlug}`} class="action-btn" aria-label="Ver episodio completo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h13M12 5l7 7-7 7"/></svg>
                </a>
            </div>
            <div class="scroll-indicator">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 13l5 5 5-5M7 6l5 5 5-5"/></svg>
            </div>
          </div>
        </div>
      )})
    ) : (
      <div class="no-clips">
        <p>No hay clips disponibles por el momento.</p>
        <a href="/ep" class="back-btn">Ver episodios</a>
      </div>
    )}
  </div>

  <!-- Episode Clips Side Panel -->
  <div id="episode-panel-backdrop" class="panel-backdrop" onclick="handleCloseEpisodeClips()"></div>
  <aside id="episode-clips-panel" class="episode-clips-panel">
    <div class="panel-header">
      <button class="panel-close-btn" onclick="handleCloseEpisodeClips()" aria-label="Cerrar">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    <div class="panel-episode-hero">
      <img id="panel-episode-image" class="panel-episode-cover" src="" alt="" />
      <div class="panel-episode-meta">
        <h3 id="panel-episode-title" class="panel-episode-title">Episodio</h3>
        <span id="panel-clips-count" class="panel-clips-count"></span>
      </div>
    </div>
    <div id="panel-clips-grid" class="panel-clips-grid">
      <!-- Populated dynamically -->
    </div>
  </aside>

  <!-- Inject clips-by-episode data for JS -->
  <script is:inline define:vars={{ clipsByEpisode }}>
    window._clipsByEpisode = clipsByEpisode;
  </script>
</Layout>

<style>
  /* Global reset for this page */
  :global(body) {
      overflow: hidden; /* Prevent body scroll, handle in main */
      background-color: #000;
  }

  :global(main) {
    padding-top: 0 !important;
    height: 100vh;
    height: 100dvh;
    overflow-y: scroll;
    scroll-snap-type: y mandatory;
    scrollbar-width: none; /* Firefox */
  }
  
  :global(main)::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
  }

  /* Container */
  .clips-container {
    width: 100%;
    height: 100%;
  }

  /* Individual Clip Section */
  .clip-section {
    position: relative;
    width: 100%;
    height: 100vh;
    height: 100dvh;
    scroll-snap-align: start;
    scroll-snap-stop: always;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #000;
    overflow: hidden;
  }

  /* Video wrapper */
  .video-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  .youtube-player {
    width: 100%;
    height: 100%;
    max-width: 500px; /* Limit width on desktop for vertical video feel */
    aspect-ratio: 9/16;
    pointer-events: none; /* Disable native interaction mainly, but clicks might pass */
  }

  /* Interaction Layer ensures we capture taps for play/pause and block YouTube controls */
  .interaction-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 5;
      cursor: pointer;
      /* Ensure taps work on mobile */
      -webkit-tap-highlight-color: transparent;
  }

  @media (min-width: 768px) {
      .youtube-player {
          height: 90vh; /* Give some breathing room on desktop */
          border-radius: 20px;
          overflow: hidden;
      }
      
      /* Match interaction layer to player size on desktop */
      .video-wrapper {
          width: auto;
      }
      .youtube-player, .interaction-layer {
          width: auto;
          aspect-ratio: 9/16;
      }
  }

  /* Overlay UI */
  .clip-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%;
    padding: 2rem 1.5rem 6rem; /* Extra padding at bottom for mobile nav bars */
    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.2) 30%, transparent 100%);
    pointer-events: none; /* Let clicks pass through */
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    z-index: 10;
  }

  .clip-info {
    position: absolute;
    left: 1.5rem;
    bottom: 6rem;
    max-width: 75%;
    pointer-events: auto;
    z-index: 20;
  }

  .clip-title {
    color: white;
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .episode-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    font-size: 0.85rem;
    background: rgba(0, 0, 0, 0.5);
    padding: 0.4rem 0.8rem;
    border-radius: 99px;
    backdrop-filter: blur(8px);
    transition: background 0.2s;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .episode-link:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .clip-actions {
    position: absolute;
    right: 1rem;
    bottom: 6rem;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    pointer-events: auto;
    z-index: 20;
    align-items: center;
  }

  .action-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(30, 30, 30, 0.5);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
  }

  .action-btn:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
  }

  .action-btn.liked {
      background: rgba(255, 255, 255, 1);
      color: #ef4444; /* Red color */
      border-color: #ef4444;
  }
  
  .action-btn.liked svg {
      fill: #ef4444;
  }
  
  .scroll-indicator {
      position: absolute;
      bottom: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255,255,255,0.5);
      animation: bounce 2s infinite;
      z-index: 5;
  }
  
  @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {transform: translateX(-50%) translateY(0);}
      40% {transform: translateX(-50%) translateY(-10px);}
      60% {transform: translateX(-50%) translateY(-5px);}
  }

  /* No clips state */
  .no-clips {
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: rgba(255,255,255,0.7);
    gap: 1rem;
  }
  
  .back-btn {
      padding: 0.75rem 1.5rem;
      background: var(--color-primary, #8b5cf6);
      color: white;
      text-decoration: none;
      border-radius: 99px;
      font-weight: 600;
  }

  /* Desktop adjustments */
  @media (min-width: 768px) {
    .clip-overlay {
        justify-content: center;
        align-items: center;
        pointer-events: none;
        background: transparent;
    }
    
    .clip-info {
        position: absolute;
        bottom: 2rem;
        right: 50%;
        margin-right: 270px;
        left: auto;
        transform: none;
        width: 300px;
        text-align: right;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }
    
    .clip-actions {
        position: absolute;
        bottom: 2rem;
        left: 50%;
        margin-left: 270px;
        right: auto;
        transform: none;
        align-items: flex-start;
    }

    .scroll-indicator {
        display: none;
    }
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  /* Episode Clips ‚Äî Side Panel (Drawer)                       */
  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

  .panel-backdrop {
    position: fixed;
    inset: 0;
    z-index: 999;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.35s ease, visibility 0s 0.35s;
  }

  .panel-backdrop.active {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transition: opacity 0.35s ease, visibility 0s 0s;
  }

  .episode-clips-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    background: linear-gradient(
      180deg,
      rgba(18, 15, 28, 0.98) 0%,
      rgba(12, 10, 20, 0.99) 100%
    );
    border-left: 1px solid rgba(139, 92, 246, 0.12);
    transform: translateX(100%);
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: -8px 0 40px rgba(0, 0, 0, 0.4);
  }

  .episode-clips-panel.active {
    transform: translateX(0);
  }

  /* Panel Header */
  .panel-header {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 1rem 1.25rem;
    flex-shrink: 0;
  }

  .panel-close-btn {
    width: 38px;
    height: 38px;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: rgba(255, 255, 255, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .panel-close-btn:hover {
    background: rgba(255, 255, 255, 0.12);
    color: white;
    transform: rotate(90deg);
  }

  /* Episode Hero Section */
  .panel-episode-hero {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0 1.25rem 1.25rem;
    flex-shrink: 0;
    position: relative;
  }

  .panel-episode-hero::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 1.25rem;
    right: 1.25rem;
    height: 1px;
    background: linear-gradient(
      90deg,
      transparent,
      rgba(139, 92, 246, 0.25) 30%,
      rgba(139, 92, 246, 0.25) 70%,
      transparent
    );
  }

  .panel-episode-cover {
    width: 64px;
    height: 64px;
    border-radius: 14px;
    object-fit: cover;
    flex-shrink: 0;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.08);
  }

  .panel-episode-meta {
    min-width: 0;
  }

  .panel-episode-title {
    color: #f0edf6;
    font-size: 1rem;
    font-weight: 700;
    margin: 0;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    letter-spacing: -0.01em;
  }

  .panel-clips-count {
    display: inline-block;
    margin-top: 0.35rem;
    font-size: 0.75rem;
    color: rgba(139, 92, 246, 0.8);
    font-weight: 600;
    letter-spacing: 0.02em;
  }

  /* Clips Grid */
  .panel-clips-grid {
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    align-content: start;
    overscroll-behavior: contain;
    scrollbar-width: thin;
    scrollbar-color: rgba(139, 92, 246, 0.2) transparent;
  }

  .panel-clips-grid::-webkit-scrollbar {
    width: 4px;
  }

  .panel-clips-grid::-webkit-scrollbar-track {
    background: transparent;
  }

  .panel-clips-grid::-webkit-scrollbar-thumb {
    background: rgba(139, 92, 246, 0.2);
    border-radius: 99px;
  }

  /* Desktop: fixed-width drawer */
  @media (min-width: 768px) {
    .episode-clips-panel {
      width: 420px;
      border-radius: 20px 0 0 20px;
      box-shadow:
        -12px 0 60px rgba(0, 0, 0, 0.5),
        -2px 0 20px rgba(139, 92, 246, 0.06);
    }

    .panel-episode-cover {
      width: 72px;
      height: 72px;
    }

    .panel-episode-title {
      font-size: 1.05rem;
    }
  }

  /* Small mobile: 2 columns */
  @media (max-width: 380px) {
    .panel-clips-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<!-- Global styles for dynamically generated content (JS-injected HTML doesn't get Astro scoping) -->
<style is:global>
  /* Grid Clip Card ‚Äî 9:16 portrait */
  .grid-clip-card {
    position: relative;
    display: block;
    text-decoration: none;
    color: white;
    border-radius: 10px;
    overflow: hidden;
    background: #111;
    border: 1px solid rgba(255, 255, 255, 0.08);
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    opacity: 0;
    transform: translateY(16px) scale(0.96);
    animation: gridCardIn 0.4s ease forwards;
  }

  @keyframes gridCardIn {
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .grid-clip-card:hover {
    border-color: rgba(139, 92, 246, 0.4);
    transform: translateY(-3px) scale(1.03);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(139, 92, 246, 0.15);
  }

  .grid-clip-card:active {
    transform: scale(0.97);
  }

  .grid-clip-card.active-clip {
    border-color: rgba(139, 92, 246, 0.5);
    box-shadow: 0 0 20px rgba(139, 92, 246, 0.15);
  }

  /* Image in normal flow ‚Äî its aspect-ratio defines the card height */
  .grid-clip-card img {
    display: block;
    width: 100%;
    aspect-ratio: 9 / 16;
    object-fit: cover;
    object-position: center;
    transition: transform 0.35s ease;
  }

  .grid-clip-card:hover img {
    transform: scale(1.08);
  }

  /* Title overlay at bottom with gradient */
  .grid-clip-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 2rem 0.5rem 0.5rem;
    background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.4) 55%, transparent 100%);
    z-index: 4;
  }

  .grid-clip-title {
    font-size: 0.58rem;
    font-weight: 600;
    line-height: 1.2;
    color: rgba(255, 255, 255, 0.92);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-shadow: 0 1px 3px rgba(0,0,0,0.7);
  }

  .grid-clip-card:hover .grid-clip-title {
    color: #fff;
  }

  .grid-clip-card.active-clip .grid-clip-title {
    color: rgba(200, 170, 255, 1);
  }

  /* Play overlay */
  .grid-play-icon {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.35);
    opacity: 0;
    transition: opacity 0.25s ease;
    z-index: 3;
  }

  .grid-clip-card:hover .grid-play-icon {
    opacity: 1;
  }

  .grid-play-icon svg {
    filter: drop-shadow(0 2px 6px rgba(0, 0, 0, 0.6));
  }

  /* Number badge */
  .grid-clip-badge {
    position: absolute;
    top: 4px;
    left: 4px;
    background: rgba(0, 0, 0, 0.7);
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.5rem;
    font-weight: 700;
    padding: 1px 5px;
    border-radius: 4px;
    z-index: 5;
    line-height: 1.2;
    backdrop-filter: blur(4px);
  }

  /* Active indicator */
  .grid-clip-card.active-clip::after {
    content: '‚ñ∂';
    position: absolute;
    top: 4px;
    right: 4px;
    background: rgba(139, 92, 246, 0.9);
    color: white;
    font-size: 0.45rem;
    padding: 2px 5px;
    border-radius: 4px;
    font-weight: 700;
    z-index: 5;
  }

  @media (min-width: 768px) {
    .grid-clip-title {
      font-size: 0.62rem;
    }
  }
</style>

<script is:inline>
    // Use an IIFE or just global scope carefully. 
    // Since Astro viewtransitions re-runs scripts, we need to be careful about redeclaring variables.
    // The previous implementation had 'let players' at top level which is fine for module scope, 
    // BUT if the script tag is re-injected, it re-runs.
    
    // We will attach state to window to survive re-runs and avoid "redeclaration" errors if this were a classic script,
    // though as a module it should be fine. However, let's be extremely robust.

    (function() {
        const WIN = window;
        
        // Initialize global state container if not exists
        if (!WIN._clipsState) {
            WIN._clipsState = {
                players: {},
                playbackObserver: null,
                loadingObserver: null,
                urlObserver: null,
                queue: [],
                apiReady: false,
                stateCache: new Map()
            };
        }

        const state = WIN._clipsState;

        // --- YOUTUBE API SETUP ---
        if (!WIN.YT) {
            if (!document.getElementById('yt-api-script')) {
                const tag = document.createElement('script');
                tag.id = 'yt-api-script';
                tag.src = "https://www.youtube.com/iframe_api";
                const firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag?.parentNode?.insertBefore(tag, firstScriptTag);
            }
            
            WIN.onYouTubeIframeAPIReady = function() {
                state.apiReady = true;
                processQueue();
            };
        } else {
            state.apiReady = true;
            // Process queue next tick to ensure DOM is ready if valid
            setTimeout(processQueue, 0);
        }

        function processQueue() {
            while (state.queue.length > 0) {
                const id = state.queue.shift();
                if (id) createPlayer(id);
            }
        }

        function createPlayer(id) {
            // Check global YT object
            if (!WIN.YT || !WIN.YT.Player) {
                if (!state.queue.includes(id)) state.queue.push(id);
                return;
            }

            if (state.players[id]) return; // Already created

            const element = document.getElementById(id);
            if (!element) return;

            const videoId = element.getAttribute('data-video-id');
            if (!videoId) return;

            // Create player
            state.players[id] = new WIN.YT.Player(id, {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'playsinline': 1,
                    'controls': 0,
                    'rel': 0,
                    'modestbranding': 1,
                    'showinfo': 0, 
                    'iv_load_policy': 3, 
                    'fs': 0,
                    'disablekb': 1,
                    'origin': WIN.location.origin
                },
                events: {
                    'onStateChange': (e) => onPlayerStateChange(id, e)
                }
            });
        }

        function onPlayerStateChange(id, event) {
            state.stateCache.set(id, event.data);
            if (event.data === WIN.YT.PlayerState.ENDED) {
                event.target.playVideo();
            }
        }

        function togglePlay(id) {
            const player = state.players[id];
            if (player && typeof player.getPlayerState === 'function') {
                const playerState = player.getPlayerState();
                if (playerState === WIN.YT.PlayerState.PLAYING) {
                    player.pauseVideo();
                } else {
                    player.playVideo();
                    player.unMute();
                }
            }
        }

        // --- OBSERVERS ---
        function initObservers() {
            // Loading
            state.loadingObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const playerDiv = entry.target.querySelector('.youtube-player');
                        if (playerDiv) createPlayer(playerDiv.id);
                    }
                });
            }, { root: null, rootMargin: '50% 0px 50% 0px' });

            // Playback
            state.playbackObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const playerDiv = entry.target.querySelector('.youtube-player');
                    if (!playerDiv) return;
                    const id = playerDiv.id;
                    const player = state.players[id];
                    
                    if (entry.isIntersecting) {
                        if (player && typeof player.playVideo === 'function') player.playVideo();
                    } else {
                        if (player && typeof player.pauseVideo === 'function') player.pauseVideo();
                    }
                });
            }, { root: null, rootMargin: '0px', threshold: 0.6 });

            document.querySelectorAll('.clip-section').forEach(section => {
                state.loadingObserver.observe(section);
                state.playbackObserver.observe(section);
            });

            // Interaction Layer Clicks
            document.querySelectorAll('.interaction-layer').forEach((layer) => {
                // Remove old listeners? The elements are new on page load, so simple add is fine.
                layer.onclick = (e) => {
                    const targetId = e.currentTarget.getAttribute('data-target');
                    if (targetId) togglePlay(targetId);
                };
            });
        }

        function checkWatchParam() {
            const urlParams = new URLSearchParams(WIN.location.search);
            const watchId = urlParams.get('watch');
            if (!watchId) {
                const firstPlayer = document.querySelector('.youtube-player');
                if (firstPlayer) {
                    const firstId = firstPlayer.getAttribute('data-video-id');
                    if (firstId) {
                        const url = new URL(WIN.location.href);
                        url.searchParams.set('watch', firstId);
                        WIN.history.replaceState({}, '', url);
                    }
                }
            }
        }

        function initUrlObserver() {
            if (state.urlObserver) state.urlObserver.disconnect();
            
            state.urlObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const playerDiv = entry.target.querySelector('.youtube-player');
                        if (playerDiv) {
                            const videoId = playerDiv.getAttribute('data-video-id');
                            if (videoId) {
                                const url = new URL(WIN.location.href);
                                if (url.searchParams.get('watch') !== videoId) {
                                    url.searchParams.set('watch', videoId);
                                    WIN.history.replaceState({}, '', url);
                                }
                            }
                        }
                    }
                });
            }, { threshold: 0.7 });

            document.querySelectorAll('.clip-section').forEach(section => {
                state.urlObserver.observe(section);
            });
        }

        // --- GLOBAL ACTIONS (for onclick) ---
        WIN.handleLikeClip = async function(btn) {
            if (WIN.event) {
                WIN.event.stopPropagation();
                WIN.event.preventDefault();
            }

            const clipId = btn.getAttribute('data-clip-id');
            if (!clipId) return;

            const isLiked = btn.classList.contains('liked');

            // Optimistic
            if (isLiked) {
                btn.classList.remove('liked');
                btn.querySelector('svg')?.setAttribute('fill', 'none');
            } else {
                btn.classList.add('liked');
                btn.querySelector('svg')?.setAttribute('fill', '#ef4444');
                btn.animate([{transform:'scale(1)'}, {transform:'scale(1.3)'}, {transform:'scale(1)'}], {duration:200});
            }

            try {
                const res = await fetch('/api/clips/like', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({clipId})
                });
                if (res.status === 401) {
                    WIN.location.href = '/login';
                    return;
                }
            } catch(e) {
                console.error(e);
                // Revert
                 if (isLiked) {
                    btn.classList.add('liked');
                    btn.querySelector('svg')?.setAttribute('fill', '#ef4444');
                } else {
                    btn.classList.remove('liked');
                    btn.querySelector('svg')?.setAttribute('fill', 'none');
                }
            }
        };

        WIN.handleShareClip = function(btn) {
            if (WIN.event) {
                WIN.event.stopPropagation();
                WIN.event.preventDefault();
            }
            const clipId = btn.getAttribute('data-clip-id');
            const url = new URL(WIN.location.href);
            if (clipId) url.searchParams.set('watch', clipId);
            
            navigator.clipboard.writeText(url.toString()).then(() => {
                const original = btn.innerHTML;
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                setTimeout(() => { btn.innerHTML = original; }, 2000);
            });
        };

        // --- EPISODE CLIPS SIDE PANEL ---
        WIN.handleOpenEpisodeClips = function(btn) {
            if (WIN.event) {
                WIN.event.stopPropagation();
                WIN.event.preventDefault();
            }

            const slug = btn.getAttribute('data-episode-slug');
            if (!slug || !WIN._clipsByEpisode) return;

            const episodeData = WIN._clipsByEpisode[slug];
            if (!episodeData || !episodeData.clips || episodeData.clips.length === 0) return;

            const panel = document.getElementById('episode-clips-panel');
            const backdrop = document.getElementById('episode-panel-backdrop');
            const grid = document.getElementById('panel-clips-grid');
            const titleEl = document.getElementById('panel-episode-title');
            const imageEl = document.getElementById('panel-episode-image');
            const countEl = document.getElementById('panel-clips-count');
            if (!panel || !grid || !titleEl || !imageEl || !countEl || !backdrop) return;

            // Get current watch param to highlight active clip
            const currentWatch = new URLSearchParams(WIN.location.search).get('watch');

            // Populate episode info
            titleEl.textContent = episodeData.episodeTitle;
            imageEl.src = episodeData.episodeImage;
            imageEl.alt = episodeData.episodeTitle;
            countEl.textContent = 'üé¨ ' + episodeData.clips.length + ' clips';

            // Build grid HTML with staggered animation
            grid.innerHTML = episodeData.clips.map((clip, i) => {
                const thumbUrl = clip.videoId 
                    ? 'https://img.youtube.com/vi/' + clip.videoId + '/hqdefault.jpg'
                    : '';
                const isActive = clip.videoId === currentWatch;
                const delay = (i * 0.06).toFixed(2);
                return '<a class="grid-clip-card' + (isActive ? ' active-clip' : '') + '" href="/clips?watch=' + (clip.videoId || '') + '" style="animation-delay:' + delay + 's">' +
                    '<span class="grid-clip-badge">' + (i + 1) + '</span>' +
                    '<img src="' + thumbUrl + '" alt="" loading="lazy" />' +
                    '<div class="grid-play-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="white"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg></div>' +
                    '<div class="grid-clip-info">' +
                        '<div class="grid-clip-title">' + clip.title + '</div>' +
                    '</div>' +
                '</a>';
            }).join('');

            // Show panel + backdrop
            panel.classList.add('active');
            backdrop.classList.add('active');
        };

        WIN.handleCloseEpisodeClips = function() {
            const panel = document.getElementById('episode-clips-panel');
            const backdrop = document.getElementById('episode-panel-backdrop');
            if (panel) panel.classList.remove('active');
            if (backdrop) backdrop.classList.remove('active');
        };

        // Close panel on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const panel = document.getElementById('episode-clips-panel');
                if (panel && panel.classList.contains('active')) {
                    WIN.handleCloseEpisodeClips();
                }
            }
        });

        async function loadLikes() {
            try {
                const res = await fetch('/api/clips/liked');
                if (res.ok) {
                    const data = await res.json();
                    const liked = data.likedClips || [];
                    document.querySelectorAll('.like-btn').forEach(btn => {
                        const cid = btn.getAttribute('data-clip-id');
                        if (cid && liked.includes(cid)) {
                            btn.classList.add('liked');
                            btn.querySelector('svg')?.setAttribute('fill', '#ef4444');
                        }
                    });
                }
            } catch(e) { console.error(e); }
        }

        // --- INIT ---
        function initPage() {
            // Only run on clips page
            if (!document.querySelector('.clips-container')) return;
            
            // Cleanup
            if (state.loadingObserver) state.loadingObserver.disconnect();
            if (state.playbackObserver) state.playbackObserver.disconnect();
            if (state.urlObserver) state.urlObserver.disconnect();
            
            // Destroy old players
            Object.values(state.players).forEach(p => { 
                if(p && typeof p.destroy === 'function') { try { p.destroy(); } catch(e) {} }
            });
            state.players = {};

            // Start
            initObservers();
            loadLikes();
            checkWatchParam();
            initUrlObserver();
        }

        // Register astro:page-load only once (guard against duplicate registration on script re-run)
        if (!WIN._clipsPageLoadRegistered) {
            WIN._clipsPageLoadRegistered = true;
            document.addEventListener('astro:page-load', initPage);
        }
        
        // CRITICAL: Also call initPage() immediately!
        // With is:inline, the astro:page-load event may have already fired before this script runs.
        // So we must initialize now.
        initPage();
        
    })();
</script>
