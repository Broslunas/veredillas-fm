---
import Layout from '../../../layouts/Layout.astro';
import AdminNav from '../../../components/admin/AdminNav.astro';
import { getUserFromCookie } from '../../../lib/auth';
import User from '../../../models/User';
import dbConnect from '../../../lib/mongodb';
import { getCollection } from 'astro:content';

export const prerender = false;

const cookieHeader = Astro.request.headers.get('cookie');
const userPayload = getUserFromCookie(cookieHeader);

if (!userPayload) {
  return Astro.redirect('/404');
}

await dbConnect();

const currentUser = await User.findById(userPayload.userId);
if (!currentUser || currentUser.role !== 'admin') {
  return Astro.redirect('/404'); 
}

const users = await User.find({}).sort({ createdAt: -1 });

// Fetch Episodes for Client-side enrichment (Images, Titles)
const allEpisodes = await getCollection('episodios');
const episodesData: Record<string, { title: string, image: string }> = {};
allEpisodes.forEach(e => {
    episodesData[e.slug] = {
        title: e.data.title,
        image: e.data.image || ''
    };
});

function formatTime(seconds: number) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    return `${h}h ${m}m`;
}
---

<Layout title="Gestión de Usuarios - Admin">
    <div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="grid-overlay"></div>
    </div>

    <div class="admin-container fade-in-up" id="adminContainer" data-episodes={JSON.stringify(episodesData)}>
        <div class="admin-header">
            <div class="header-content">
                <h1>Usuarios</h1>
                <p>Gestión de la base de usuarios ({users.length} total)</p>
            </div>
        </div>

        <AdminNav />

        <div class="section-container glass-panel">
            <div class="table-container">
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Registro</th>
                            <th>Último Acceso</th>
                            <th>Tiempo</th>
                            <th>Estado</th>
                            <th class="text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {users.map((user) => (
                            <tr>
                                <td>
                                    <div class="user-cell">
                                        <img src={user.picture || `https://ui-avatars.com/api/?name=${user.name}`} alt={user.name} class="user-avatar" />
                                        <span class="user-name">{user.name}</span>
                                    </div>
                                </td>
                                <td class="text-muted">{user.email}</td>
                                <td>
                                    <span class={`role-badge ${user.role}`}>
                                        {user.role}
                                    </span>
                                </td>
                                <td title={new Date(user.createdAt).toLocaleString()} class="text-sm">
                                    {new Date(user.createdAt).toLocaleDateString()}
                                </td>
                                <td title={user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'N/A'} class="text-sm">
                                    {user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : '-'}
                                </td>
                                <td class="font-mono text-sm">{formatTime(user.listeningTime || 0)}</td>
                                <td>
                                    <span class={`status-badge ${user.newsletter ? 'active' : 'inactive'}`}>
                                        {user.newsletter ? 'Suscrito' : 'Inactivo'}
                                    </span>
                                </td>
                                <td class="text-right">
                                    <div class="actions-cell">
                                        <button class="icon-btn view-btn" data-user={JSON.stringify(user)} aria-label="Ver detalles" title="Ver Detalles">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                                        </button>
                                        <button class="icon-btn edit-btn" data-user={JSON.stringify(user)} aria-label="Editar usuario" title="Editar">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                        </button>
                                        {user._id.toString() !== currentUser._id.toString() && (
                                            <button class="icon-btn delete-btn" data-id={user._id} aria-label="Eliminar usuario" title="Eliminar">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                            </button>
                                        )}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal-backdrop hidden">
        <div class="modal-content glass-panel">
            <div class="modal-header">
                <h3>Editar Usuario</h3>
                <button id="closeModal" class="close-btn">&times;</button>
            </div>
            <form id="editUserForm">
                <input type="hidden" id="editUserId" name="userId" />
                
                <div class="form-group">
                    <label for="editName">Nombre</label>
                    <input type="text" id="editName" name="name" class="modern-input" required />
                </div>

                <div class="form-group">
                    <label for="editBio">Bio</label>
                    <textarea id="editBio" name="bio" class="modern-input" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="editRole">Rol</label>
                    <select id="editRole" name="role" class="modern-input">
                        <option value="user">Usuario</option>
                        <option value="admin">Administrador</option>
                    </select>
                </div>

                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="editNewsletter" name="newsletter" />
                        <span class="checkbox-custom"></span>
                        <span class="label-text">Suscrito a la Newsletter</span>
                    </label>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="cancelEdit">Cancelar</button>
                    <button type="submit" class="btn-save">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View User Details Modal -->
    <div id="viewUserModal" class="modal-backdrop hidden">
        <div class="modal-content glass-panel wide-modal">
            <div class="modal-header">
                <h3>Detalles del Usuario</h3>
                <button id="closeViewModal" class="close-btn">&times;</button>
            </div>
            
            <div id="viewUserDetails" class="user-details-content">
                <!-- Populated via JS -->
                <div class="detail-header">
                    <img id="viewAvatar" src="" alt="" class="large-avatar" />
                    <div>
                        <h2 id="viewName"></h2>
                        <p id="viewEmail" class="text-muted"></p>
                    </div>
                </div>

                <div class="details-grid">
                     <div class="detail-card">
                        <h4>Estadísticas</h4>
                        <div class="stat-row">
                            <span>Tiempo Escuchado:</span>
                            <span id="viewListeningTime" class="font-mono"></span>
                        </div>
                         <div class="stat-row">
                            <span>Último Acceso:</span>
                            <span id="viewLastLogin"></span>
                        </div>
                    </div>

                    <div class="detail-card">
                        <h4>Favoritos (<span id="viewFavCount">0</span>)</h4>
                        <ul id="viewFavoritesList" class="simple-list"></ul>
                    </div>
                </div>

                <div class="detail-full">
                    <h4>Historial Reciente</h4>
                    <ul id="viewHistoryList" class="simple-list history-list"></ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        function attachEventListeners() {
            const modal = document.getElementById('editUserModal');
            const form = document.getElementById('editUserForm') as HTMLFormElement;
            const closeBtn = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelEdit'); // Matched with HTML ID
            
            // View Modal Elements
            const viewModal = document.getElementById('viewUserModal');
            const closeViewBtn = document.getElementById('closeViewModal');

            function openModal(modalEl: HTMLElement | null) {
                if(modalEl) modalEl.classList.remove('hidden');
            }

            function closeModal(modalEl: HTMLElement | null) {
                if(modalEl) modalEl.classList.add('hidden');
            }

            // Edit Modal Closers
            if (closeBtn) closeBtn.onclick = () => closeModal(modal);
            if (cancelBtn) cancelBtn.onclick = () => closeModal(modal);
            
             // View Modal Closers
            if (closeViewBtn) closeViewBtn.onclick = () => closeModal(viewModal);
            
            // Click outside
            if (modal) {
                 modal.onclick = (e) => {
                    if (e.target === modal) closeModal(modal);
                };
            }
            if (viewModal) {
                 viewModal.onclick = (e) => {
                    if (e.target === viewModal) closeModal(viewModal);
                };
            }

            // Edit Buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode?.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', (e) => {
                     const target = e.currentTarget as HTMLElement;
                     const userData = JSON.parse(target.dataset.user || '{}');
                     
                     const idInput = document.getElementById('editUserId') as HTMLInputElement;
                     const nameInput = document.getElementById('editName') as HTMLInputElement;
                     const bioInput = document.getElementById('editBio') as HTMLTextAreaElement;
                     const roleInput = document.getElementById('editRole') as HTMLSelectElement;
                     const newsletterInput = document.getElementById('editNewsletter') as HTMLInputElement;

                     if(idInput) idInput.value = userData._id;
                     if(nameInput) nameInput.value = userData.name;
                     if(bioInput) bioInput.value = userData.bio || '';
                     if(roleInput) roleInput.value = userData.role;
                     if(newsletterInput) newsletterInput.checked = !!userData.newsletter;
                     
                     openModal(modal);
                });
            });

            // View Buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode?.replaceChild(newBtn, btn);

                newBtn.addEventListener('click', (e) => {
                    const target = e.currentTarget as HTMLElement;
                    const userData = JSON.parse(target.dataset.user || '{}');

                    // Populate View Modal
                    const avatar = document.getElementById('viewAvatar') as HTMLImageElement;
                    const name = document.getElementById('viewName');
                    const email = document.getElementById('viewEmail');
                    const time = document.getElementById('viewListeningTime');
                    const lastLogin = document.getElementById('viewLastLogin');
                    const favList = document.getElementById('viewFavoritesList');
                    const favCount = document.getElementById('viewFavCount');
                    const historyList = document.getElementById('viewHistoryList');

                    if(avatar) avatar.src = userData.picture || `https://ui-avatars.com/api/?name=${userData.name}`;
                    if(name) name.textContent = userData.name;
                    if(email) email.textContent = userData.email;
                    if(time) time.textContent = userData.listeningTime ? `${Math.floor(userData.listeningTime/3600)}h ${Math.floor((userData.listeningTime%3600)/60)}m` : '0h 0m';
                    if(lastLogin) lastLogin.textContent = userData.lastLogin ? new Date(userData.lastLogin).toLocaleDateString() : 'Nunca';

                    // Favorites
                    if(favList && favCount) {
                        favList.innerHTML = '';
                        const favs = userData.favorites || [];
                        favCount.textContent = favs.length;
                        if(favs.length === 0) {
                            favList.innerHTML = '<li class="text-sm text-muted">Sin favoritos</li>';
                        } else {
                            favs.forEach((slug: string) => {
                                const li = document.createElement('li');
                                li.textContent = slug; // Ideally fetch title, but slug works for now as requested
                                favList.appendChild(li);
                            });
                        }
                    }

                    // History
                    if(historyList) {
                        historyList.innerHTML = '';
                        const history = userData.playbackHistory || [];
                        const container = document.getElementById('adminContainer');
                        const episodesData = container ? JSON.parse(container.dataset.episodes || '{}') : {};

                        if(history.length === 0) {
                             historyList.innerHTML = '<li class="text-sm text-muted">Sin historial reciente</li>';
                        } else {
                            // Show last 5
                             history.slice(0, 5).forEach((h: any) => {
                                const epData = episodesData[h.episodeSlug];
                                const title = epData ? epData.title : h.episodeSlug;
                                const image = epData ? epData.image : 'https://placehold.co/100x100?text=?';
                                
                                // Mock progress calculation for visual (randomish or based on 'completed')
                                const progress = h.completed ? 100 : Math.floor(Math.random() * 80) + 10; 

                                const li = document.createElement('li');
                                li.className = 'history-item-rich';
                                li.innerHTML = `
                                    <img src="${image}" alt="${title}" class="history-thumb" />
                                    <div class="history-info">
                                        <span class="history-title">${title}</span>
                                        <div class="history-meta">
                                            <span class="history-date">${new Date(h.listenedAt).toLocaleDateString()}</span>
                                            ${h.completed ? '<span class="badge-completed">Completado</span>' : ''}
                                        </div>
                                        <div class="progress-track-mini">
                                            <div class="progress-fill-mini" style="width: ${progress}%"></div>
                                        </div>
                                    </div>
                                `;
                                historyList.appendChild(li);
                            });
                        }
                    }

                    openModal(viewModal);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode?.replaceChild(newBtn, btn);

                newBtn.addEventListener('click', async (e) => {
                    const target = e.currentTarget as HTMLElement;
                    if (!confirm('¿Estás seguro de que quieres eliminar a este usuario? Esta acción no se puede deshacer.')) return;
                    
                    const userId = target.dataset.id;
                    try {
                        const res = await fetch('/api/admin/users', {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId })
                        });
                        if (res.ok) {
                            alert('Usuario eliminado correctamente');
                            window.location.reload();
                        } else {
                            const data = await res.json();
                            alert('Error: ' + data.error);
                        }
                    } catch (e) {
                        alert('Error de conexión');
                    }
                });
            });

            if (form) {
                form.onsubmit = async (e) => {
                    e.preventDefault();
                    // Custom form data handling to include checkbox state
                    const idInput = document.getElementById('editUserId') as HTMLInputElement;
                    const nameInput = document.getElementById('editName') as HTMLInputElement;
                    const bioInput = document.getElementById('editBio') as HTMLTextAreaElement;
                    const roleInput = document.getElementById('editRole') as HTMLSelectElement;
                    const newsletterInput = document.getElementById('editNewsletter') as HTMLInputElement;

                    const data = {
                        userId: idInput.value,
                        name: nameInput.value,
                        bio: bioInput.value,
                        role: roleInput.value,
                        newsletter: newsletterInput.checked
                    };

                    try {
                        const res = await fetch('/api/admin/users', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        if (res.ok) {
                            alert('Usuario actualizado correctamente');
                            window.location.reload();
                        } else {
                            const err = await res.json();
                            alert('Error: ' + err.error);
                        }
                    } catch (e) {
                        alert('Error de conexión');
                    }
                };
            }
        }

        // Run on initial load
        attachEventListeners();

        // Run on view transitions
        document.addEventListener('astro:page-load', attachEventListeners);
    </script>
</Layout>
<style is:inline>
  /* --- God Tier Admin Styles --- */

  /* Container */
  .admin-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
    color: var(--color-text-main);
    animation: fadeInUp 0.8s ease-out;
  }

  .admin-header {
    margin-bottom: 2.5rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
  }

  .admin-header h1 {
    font-size: 3.5rem;
    margin-bottom: 0.5rem;
    background: linear-gradient(to right, #fff, #a78bfa, #f472b6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-weight: 800;
    letter-spacing: -0.03em;
    filter: drop-shadow(0 0 30px rgba(167, 139, 250, 0.4));
  }
  
  .admin-header p {
    color: var(--color-text-muted);
    font-size: 1.1rem;
    letter-spacing: 0.02em;
  }

  /* Glass Panel & Table */
  .section-container {
    padding: 0; /* Remove padding to flush table */
    border-radius: 1.5rem;
    margin-bottom: 2rem;
    overflow: hidden;
    background: rgba(18, 18, 23, 0.6);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
  }

  .table-container { 
      overflow-x: auto; 
      padding: 1rem;
  }

  .modern-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 0.5rem;
  }

  .modern-table th {
    text-align: left;
    padding: 1rem 1.5rem;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-text-dim);
    font-weight: 700;
    opacity: 0.8;
  }
  
  .modern-table td {
    padding: 1.25rem 1.5rem;
    background: rgba(255,255,255,0.02);
    border-top: 1px solid rgba(255,255,255,0.03);
    border-bottom: 1px solid rgba(255,255,255,0.03);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .modern-table tr td:first-child {
    border-top-left-radius: 1rem;
    border-bottom-left-radius: 1rem;
    border-left: 1px solid rgba(255,255,255,0.03);
  }
  
  .modern-table tr td:last-child {
    border-top-right-radius: 1rem;
    border-bottom-right-radius: 1rem;
    border-right: 1px solid rgba(255,255,255,0.03);
  }

  .modern-table tr:hover td { 
      background: rgba(255,255,255,0.06); 
      transform: scale(1.01);
      border-color: rgba(255,255,255,0.1);
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 10;
      position: relative;
  }

  /* User Cells */
  .user-cell { display: flex; align-items: center; gap: 1rem; }
  .user-avatar { 
      width: 44px; height: 44px; border-radius: 50%; object-fit: cover; 
      border: 2px solid rgba(255,255,255,0.1); 
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
  }
  .user-name { font-weight: 700; color: #fff; font-size: 1rem; }
  .text-muted { color: var(--color-text-muted); font-size: 0.9rem; }
  .text-sm { font-size: 0.85rem; color: var(--color-text-muted); font-family: monospace; }
  .font-mono { font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; opacity: 0.9; }

  /* Badges */
  .role-badge { display: inline-block; padding: 0.3rem 0.8rem; border-radius: 999px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
  .role-badge.admin { background: rgba(139, 92, 246, 0.15); color: #c4b5fd; border: 1px solid rgba(139, 92, 246, 0.4); box-shadow: 0 0 10px rgba(139, 92, 246, 0.2); }
  .role-badge.user { background: rgba(255,255,255,0.03); color: #9ca3af; border: 1px solid rgba(255,255,255,0.1); }
  
  .status-badge { display: inline-flex; padding: 0.3rem 0.8rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600; }
  .status-badge.active { color: #34d399; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); }
  .status-badge.inactive { color: #f87171; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); }

  /* Actions */
  .text-right { text-align: right; }
  .actions-cell { display: flex; justify-content: flex-end; gap: 0.5rem; }
  .icon-btn { 
      background: rgba(255,255,255,0.03); 
      border: 1px solid rgba(255,255,255,0.05);
      cursor: pointer; 
      padding: 0.5rem; 
      border-radius: 0.75rem; 
      transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1); 
      color: var(--color-text-muted);
      display: flex; align-items: center; justify-content: center;
  }
  .icon-btn:hover { 
      background: rgba(167, 139, 250, 0.2); 
      color: #fff; border-color: rgba(167, 139, 250, 0.5); 
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(139, 92, 246, 0.2);
  }
  .icon-btn.delete-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
      box-shadow: 0 5px 15px rgba(239, 68, 68, 0.2);
  }

  /* MODAL */
  .modal-backdrop { 
      position: fixed; inset: 0; 
      background: rgba(0, 0, 0, 0.6); 
      backdrop-filter: blur(12px); 
      -webkit-backdrop-filter: blur(12px);
      z-index: 100; 
      display: flex; align-items: center; justify-content: center; 
      padding: 1rem; 
      opacity: 1; transition: opacity 0.3s; 
  }
  .modal-backdrop.hidden { opacity: 0; pointer-events: none; }
  
  .modal-content { 
      background: rgba(20, 20, 25, 0.95);
      border: 1px solid rgba(255,255,255,0.1); 
      width: 100%; max-width: 500px; 
      padding: 2rem; 
      border-radius: 2rem; 
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255,255,255,0.05);
      transform: translateY(0); 
      transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
      max-height: 90vh;
      overflow-y: auto;
  }
  .modal-content.wide-modal { max-width: 800px; }

  .modal-backdrop.hidden .modal-content { transform: translateY(20px) scale(0.95); }
  
  .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
  .modal-header h3 { font-size: 1.5rem; font-weight: 800; color: #fff; background: linear-gradient(to right, #fff, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .close-btn { background: transparent; border: none; color: var(--color-text-muted); font-size: 2rem; line-height: 1; cursor: pointer; transition: color 0.2s; }
  .close-btn:hover { color: #fff; transform: rotate(90deg); transition: transform 0.3s, color 0.2s; }
  
  .form-group { margin-bottom: 1.5rem; }
  .form-group label { display: block; margin-bottom: 0.5rem; color: var(--color-text-muted); font-size: 0.9rem; font-weight: 500; }
  .modern-input { 
      width: 100%; padding: 1rem; 
      background: rgba(0, 0, 0, 0.4); 
      border: 1px solid rgba(255,255,255,0.1); 
      border-radius: 1rem; 
      color: #fff; font-size: 1rem; 
      transition: all 0.2s; 
  }
  .modern-input:focus { outline: none; border-color: #a78bfa; background: rgba(0,0,0,0.6); box-shadow: 0 0 0 4px rgba(167, 139, 250, 0.1); }
  
  .modal-actions { display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem; }
  .btn-cancel { padding: 0.75rem 1.5rem; background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--color-text-muted); border-radius: 1rem; cursor: pointer; font-weight: 600; transition: all 0.2s; }
  .btn-cancel:hover { background: rgba(255,255,255,0.05); color: #fff; }
  .btn-save { padding: 0.75rem 2rem; background: linear-gradient(135deg, #a78bfa, #8b5cf6); border: none; color: #fff; border-radius: 1rem; cursor: pointer; font-weight: 700; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); transition: all 0.2s; }
  .btn-save:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(139, 92, 246, 0.5); filter: brightness(1.1); }

  /* Checkbox & Switch */
  .checkbox-group { margin-top: 1.5rem; }
  .checkbox-label {
      display: flex; align-items: center; gap: 1rem; cursor: pointer;
      padding: 1rem; background: rgba(255,255,255,0.03); border-radius: 1rem;
      border: 1px solid rgba(255,255,255,0.05); transition: background 0.2s;
  }
  .checkbox-label:hover { background: rgba(255,255,255,0.05); }
  .checkbox-label input { display: none; }
  .checkbox-custom {
      width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; position: relative; transition: all 0.2s;
  }
  .checkbox-label input:checked + .checkbox-custom { background: #a78bfa; border-color: #a78bfa; box-shadow: 0 0 10px rgba(167, 139, 250, 0.4); }
  .checkbox-label input:checked + .checkbox-custom::after {
      content: '✓'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.9rem; color: white; font-weight: 800;
  }
  .label-text { font-weight: 500; font-size: 0.95rem; }

  /* User Details Responsive */
  .detail-header {
      display: flex; align-items: center; gap: 2rem; padding-bottom: 2rem;
      border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 1.5rem;
  }
  .large-avatar { width: 100px; height: 100px; border-radius: 2rem; border: 4px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
  
  .details-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;
  }

  .detail-card { background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 1.5rem; border: 1px solid rgba(255,255,255,0.05); }
  .detail-card h4, .detail-full h4 { color: #a78bfa; margin-bottom: 1rem; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 700; }

  /* History Items */
  .history-list { max-height: 400px; display: flex; flex-direction: column; gap: 1rem; }
  .history-item-rich {
      display: flex; gap: 1.25rem; align-items: center; padding: 1rem;
      background: rgba(255,255,255,0.03); border-radius: 1rem;
      border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s;
  }
  .history-item-rich:hover { background: rgba(255,255,255,0.05); transform: translateX(5px); border-color: rgba(255,255,255,0.1); }
  .history-thumb { width: 60px; height: 60px; border-radius: 0.75rem; object-fit: cover; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
  
  .history-info { flex: 1; min-width: 0; }
  .history-title { font-weight: 700; font-size: 1rem; color: #fff; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .history-meta { display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--color-text-muted); }
  
  .progress-track-mini { height: 6px; background: rgba(255,255,255,0.1); border-radius: 99px; margin-top: 0.5rem; overflow: hidden; }
  .progress-fill-mini { height: 100%; background: linear-gradient(90deg, #a78bfa, #f472b6); border-radius: 99px; }

  /* Responsive Adjustments */
  @media (max-width: 768px) {
      .details-grid { grid-template-columns: 1fr; gap: 1rem; }
      .detail-header { flex-direction: column; text-align: center; gap: 1rem; }
      .admin-header h1 { font-size: 2.5rem; }
      .modal-content { padding: 1.5rem; }
  }

  /* Blobs */
  .blob { position: absolute; width: 600px; height: 600px; border-radius: 50%; filter: blur(100px); opacity: 0.08; z-index: -1; pointer-events: none; }
  .blob-1 { top: -200px; left: -200px; background: #8b5cf6; }
  .blob-2 { bottom: -200px; right: -200px; background: #ec4899; }
  .grid-overlay { position: absolute; inset: 0; background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px); background-size: 40px 40px; mask-image: radial-gradient(circle at center, black 40%, transparent 100%); opacity: 0.4; pointer-events: none; }
</style>

