---
import Layout from '../../../../../layouts/Layout.astro';
import { getFile, saveFile } from '../../../../../lib/cms';
import { COLLECTION_SCHEMAS } from '../../../../../lib/cmsSchemas';
import { getUserFromCookie } from '../../../../../lib/auth';
import User from '../../../../../models/User';
import dbConnect from '../../../../../lib/mongodb';

export const prerender = false;

const { collection, slug } = Astro.params;
const isNew = slug === 'new';

// Auth Check
const cookieHeader = Astro.request.headers.get('cookie');
const userPayload = getUserFromCookie(cookieHeader);
if (!userPayload) return Astro.redirect('/404');

await dbConnect();
const currentUser = await User.findById(userPayload.userId);
if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'owner')) {
  return Astro.redirect('/404');
}

// Token for Prod
let token;
if (import.meta.env.PROD) {
    const cookies = Object.fromEntries(cookieHeader.split('; ').map(c => c.split('=')));
    token = cookies['cms_gh_token'];
    if (!token) return Astro.redirect('/dashboard/admin/cms');
}

// Load File if editing
let fileData: any = { data: {}, content: '' };
let sha: string | undefined;

if (!isNew) {
    try {
        const file = await getFile(collection!, slug!, token);
        if (file) {
            fileData = file;
            sha = file.sha;
        } else {
             return Astro.redirect(`/dashboard/admin/cms/${collection}`);
        }
    } catch (e) {
        console.error(e);
        return Astro.redirect(`/dashboard/admin/cms/${collection}?error=load_failed`);
    }
} else {
    // Default data
    fileData.data = {};
}

// Handle Save (POST)
let saveError = null;
let saveSuccess = false;

if (Astro.request.method === 'POST') {
    try {
        const formData = await Astro.request.formData();
        const newSlug = formData.get('_slug') as string;
        const content = formData.get('_content') as string;
        
        // Build Frontmatter
        const schema = COLLECTION_SCHEMAS[collection!] || [];
        const frontmatter: any = {};
        
        schema.forEach((field: any) => {
            const val = formData.get(field.name);
            if (val) {
                if (field.type === 'list') {
                    frontmatter[field.name] = (val as string).split(',').map(s => s.trim());
                } else if (field.type === 'number') {
                    frontmatter[field.name] = Number(val);
                } else if (field.type === 'date') {
                     // Ensure valid date object for yaml
                     frontmatter[field.name] = new Date(val as string);
                } else {
                    frontmatter[field.name] = val;
                }
            } else if (field.name === 'author' && field.default) {
                frontmatter[field.name] = field.default; 
            }
        });

        await saveFile(collection!, newSlug, frontmatter, content, token, sha);
        
        if (isNew) {
             return Astro.redirect(`/dashboard/admin/cms/${collection}/${newSlug}?success=created`);
        } else {
             saveSuccess = true;
             // Update local state to reflect changes
             fileData.data = frontmatter;
             fileData.content = content;
             // If slug changed, redirect (todo)
        }

    } catch (e: any) {
        saveError = e.message;
    }
}

const schema = COLLECTION_SCHEMAS[collection!] || [];
---

<Layout title={`Editando: ${isNew ? 'Nuevo' : slug}`}>
    <div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="grid-overlay"></div>
    </div>

    <div class="editor-container fade-in-up">
        <div class="header-nav">
             <a href={`/dashboard/admin/cms/${collection}`} class="back-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                Cancelar
            </a>
        </div>
        
        {saveSuccess && (
            <div class="banner success mb-6">
                Cambios guardados correctamente {import.meta.env.PROD && '(en GitHub)'}
            </div>
        )}
        
         {saveError && (
            <div class="banner error mb-6">
                Error al guardar: {saveError}
            </div>
        )}

        <form method="POST" class="editor-form">
            <div class="form-header">
                <div>
                    <h1>{isNew ? 'Crear Nuevo' : 'Editar Contenido'}</h1>
                    <p class="text-xs opacity-70 font-mono">{collection}/{isNew ? '...' : slug}</p>
                </div>
                <button type="submit" class="save-btn">
                    ðŸ’¾ Guardar
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Sidebar: Frontmatter Fields -->
                <div class="sidebar glass-panel">
                    <h2 class="section-title">Metadatos</h2>
                    
                    <div class="form-group">
                        <label>Slug (URL, Identificador)</label>
                        <input type="text" name="_slug" value={isNew ? '' : slug} required pattern="[a-z0-9-]+" title="Solo letras minÃºsculas, nÃºmeros y guiones" class="input-field" placeholder="ej: mi-nuevo-post" />
                        <span class="hint">Nombre del archivo sin espacios.</span>
                    </div>

                    {schema.map((field: any) => (
                        <div class="form-group">
                            <label>{field.label} {field.required && '*'}</label>
                            
                            {field.type === 'textarea' ? (
                                <textarea name={field.name} rows="3" class="input-field" required={field.required}>{fileData.data[field.name]}</textarea>
                            ) : field.type === 'date' ? (
                                <input type="datetime-local" name={field.name} class="input-field" required={field.required} 
                                    value={fileData.data[field.name] ? new Date(fileData.data[field.name]).toISOString().slice(0, 16) : ''} />
                            ) : (
                                <input type={field.type === 'number' ? 'number' : 'text'} 
                                       name={field.name} 
                                       class="input-field" 
                                       required={field.required}
                                       value={field.type === 'list' && Array.isArray(fileData.data[field.name]) 
                                            ? fileData.data[field.name].join(', ') 
                                            : fileData.data[field.name] || ''} 
                                       placeholder={field.type === 'list' ? 'Separar con comas' : ''} />
                            )}
                        </div>
                    ))}
                </div>

                <!-- Main Content: Markdown Editor -->
                <div class="main-content lg:col-span-2">
                     <h2 class="section-title">Contenido (Markdown)</h2>
                     <div class="glass-panel p-0 overflow-hidden h-full flex flex-col">
                        <textarea name="_content" class="markdown-editor" placeholder="Escribe tu contenido aquÃ­...">{fileData.content}</textarea>
                     </div>
                </div>
            </div>
        </form>
    </div>
</Layout>

<style>
  .editor-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
    color: var(--color-text-main);
  }
  
  .back-link {
       display: inline-flex;
       align-items: center;
       gap: 0.5rem;
       color: var(--color-text-muted);
       text-decoration: none;
       margin-bottom: 2rem;
  }
  .back-link:hover { color: #fff; }

  .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
  }
  
  h1 { font-size: 2rem; font-weight: 800; }
  
  .save-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: 0.75rem;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }
  .save-btn:hover { background: #059669; transform: translateY(-2px); }

  .glass-panel {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 1rem;
      padding: 1.5rem;
  }
  
  .section-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      margin-bottom: 1rem;
      font-weight: 600;
  }

  /* Form Elements */
  .form-group { margin-bottom: 1.5rem; }
  
  label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      font-weight: 500;
  }
  
  .input-field {
      width: 100%;
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 0.5rem;
      padding: 0.75rem;
      color: white;
      font-size: 0.95rem;
  }
  
  .input-field:focus {
      outline: none;
      border-color: #a78bfa;
      background: rgba(0,0,0,0.4);
  }
  
  .hint { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem; display: block; }

  .markdown-editor {
      width: 100%;
      height: 600px;
      background: transparent;
      border: none;
      padding: 1.5rem;
      color: #e2e8f0;
      font-family: monospace;
      font-size: 1rem;
      line-height: 1.6;
      resize: vertical;
  }
  .markdown-editor:focus { outline: none; background: rgba(0,0,0,0.1); }
  
  .banner {
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-weight: 600;
  }
  .banner.success { background: rgba(16, 185, 129, 0.1); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.2); }
  .banner.error { background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }
  
  /* Background Blobs */
  .blob { position: absolute; width: 600px; height: 600px; border-radius: 50%; filter: blur(100px); opacity: 0.08; z-index: -1; }
  .blob-1 { top: -200px; left: -200px; background: var(--color-primary); }
  .blob-2 { bottom: -200px; right: -200px; background: var(--color-secondary); }
  .grid-overlay { position: absolute; inset: 0; background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px); background-size: 40px 40px; mask-image: radial-gradient(circle at center, black 40%, transparent 100%); opacity: 0.5; }
</style>
